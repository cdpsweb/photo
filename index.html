<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雲端相簿 OLED - 專業管理版</title>
    
    <!-- 外部資源 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #0a0a0a;
            --accent-color: #3b82f6;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border-color: #1e293b;
            --danger: #ef4444;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        /* 導覽列 */
        .navbar {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .btn-custom {
            border-radius: 8px;
            padding: 8px 16px;
            transition: all 0.3s;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .btn-custom:hover {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }

        /* 相簿外框 */
        .album-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.3s, border-color 0.3s;
            cursor: pointer;
            height: 100%;
        }

        .album-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-color);
        }

        .album-cover {
            width: 100%;
            aspect-ratio: 1/1;
            object-fit: cover;
            background: #111;
        }

        /* 圖片網格 */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            padding: 15px 0;
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1/1;
            border-radius: 8px;
            overflow: hidden;
            background: #111;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .photo-item:hover img {
            transform: scale(1.05);
        }

        /* 隱藏元素 */
        .hidden { display: none !important; }

        /* 讀取動畫 */
        #loadingOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .admin-controls {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.6);
            border-radius: 4px;
            padding: 2px;
            z-index: 10;
        }

        @media (max-width: 576px) {
            .photo-grid { grid-template-columns: repeat(3, 1fr); gap: 5px; }
        }
    </style>
</head>
<body>

    <!-- 讀取遮罩 -->
    <div id="loadingOverlay" class="hidden">
        <div class="spinner-border text-primary" role="status"></div>
        <div class="mt-3" id="loadingText">處理中...</div>
    </div>

    <!-- 導覽列 -->
    <nav class="navbar navbar-dark p-3">
        <div class="container-fluid">
            <span class="navbar-brand fw-bold" onclick="showAlbumList()"><i class="bi bi-images me-2"></i>雲端相簿</span>
            <div class="d-flex gap-2">
                <button class="btn btn-custom btn-sm" onclick="fetchAlbums(true)"><i class="bi bi-arrow-clockwise"></i></button>
                <button class="btn btn-custom btn-sm" id="adminLoginBtn" onclick="toggleAdmin()"><i class="bi bi-person-lock"></i></button>
                <button class="btn btn-custom btn-sm" onclick="openSettingsModal()"><i class="bi bi-gear"></i></button>
            </div>
        </div>
    </nav>

    <div class="container mt-4 mb-5">
        <!-- 初始化狀態：未設定 URL -->
        <div id="setupState" class="text-center py-5 hidden">
            <i class="bi bi-exclamation-triangle display-1 text-warning"></i>
            <h2 class="mt-4">尚未配置後端網址</h2>
            <p class="text-secondary">請點擊右上方齒輪圖示，輸入您的 Google Apps Script 部署網址。</p>
        </div>

        <!-- 相簿列表視圖 -->
        <div id="albumListView">
            <div id="adminActionHeader" class="mb-4 hidden">
                <button class="btn btn-primary" onclick="createNewAlbum()"><i class="bi bi-plus-lg me-2"></i>建立新相簿</button>
            </div>
            <div class="row g-3" id="albumGrid">
                <!-- 由 JS 動態生成 -->
            </div>
        </div>

        <!-- 相簿內照片視圖 -->
        <div id="photoDetailView" class="hidden">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="#" onclick="showAlbumList()" class="text-decoration-none text-primary">首頁</a></li>
                    <li class="breadcrumb-item active" id="currentAlbumName">相簿內容</li>
                </ol>
            </nav>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 id="albumTitleDisplay">相簿</h3>
                <div id="albumAdminButtons" class="hidden">
                    <button class="btn btn-outline-primary btn-sm" onclick="triggerUpload()"><i class="bi bi-upload"></i> 上傳</button>
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteCurrentAlbum()"><i class="bi bi-trash"></i> 刪除相簿</button>
                </div>
            </div>
            <div class="photo-grid" id="photoGrid"></div>
            <input type="file" id="fileInput" multiple accept="image/*" class="hidden" onchange="handleFileSelect(event)">
        </div>
    </div>

    <!-- 燈箱視窗 -->
    <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content bg-black border-0">
                <div class="modal-body p-0 position-relative">
                    <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3 z-3" data-bs-dismiss="modal"></button>
                    <img id="lightboxImg" src="" class="w-100 h-auto">
                    <div class="position-absolute top-50 start-0 translate-middle-y ps-3">
                        <button class="btn btn-dark rounded-circle opacity-75" onclick="navigateLightbox(-1)"><i class="bi bi-chevron-left"></i></button>
                    </div>
                    <div class="position-absolute top-50 end-0 translate-middle-y pe-3">
                        <button class="btn btn-dark rounded-circle opacity-75" onclick="navigateLightbox(1)"><i class="bi bi-chevron-right"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 設定視窗 -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">系統設定</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Google Script API 網址</label>
                        <input type="text" id="scriptUrlInput" class="form-control bg-black text-white border-secondary" placeholder="https://script.google.com/macros/s/.../exec">
                    </div>
                    <button class="btn btn-primary w-100" onclick="saveSettings()">儲存設定</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const STORAGE_KEY = 'CLOUD_ALBUM_URL';
        const SESSION_KEY_ADMIN = 'ALBUM_ADMIN_PWD';
        let SCRIPT_URL = localStorage.getItem(STORAGE_KEY);
        let albumsData = [];
        let currentAlbum = null;
        let currentPhotoIndex = 0;

        // 初始化
        window.onload = () => {
            if (!SCRIPT_URL) {
                showSetupState();
            } else {
                fetchAlbums();
                checkAdminState();
            }
        };

        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
        });

        // --- 資料存取 ---
        async function fetchAlbums(forceRefresh = false) {
            if (!SCRIPT_URL) return;
            showLoading(true, "讀取雲端相簿中...");
            try {
                const url = `${SCRIPT_URL}?action=getAlbums${forceRefresh ? '&refresh=true' : ''}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.status === "success") {
                    albumsData = result.data;
                    renderAlbums();
                    if (currentAlbum) {
                        const updated = albumsData.find(a => a.id === currentAlbum.id);
                        if (updated) openAlbum(updated.id);
                    }
                } else {
                    throw new Error(result.message);
                }
            } catch (err) {
                Swal.fire("錯誤", "連線失敗：" + err.message, "error");
            } finally {
                showLoading(false);
            }
        }

        function renderAlbums() {
            const grid = document.getElementById('albumGrid');
            const isAdmin = !!sessionStorage.getItem(SESSION_KEY_ADMIN);
            grid.innerHTML = '';
            
            // 如果是訪客，隱藏空相簿
            const displayAlbums = isAdmin ? albumsData : albumsData.filter(a => a.photos.length > 0);

            displayAlbums.forEach(album => {
                const div = document.createElement('div');
                div.className = 'col-6 col-md-4 col-lg-3';
                div.innerHTML = `
                    <div class="album-card" onclick="openAlbum('${album.id}')">
                        <img src="${album.cover || 'https://via.placeholder.com/300x300?text=No+Image'}" class="album-cover">
                        <div class="p-3">
                            <div class="fw-bold text-truncate">${album.name}</div>
                            <small class="text-secondary">${album.photos.length} 張照片</small>
                        </div>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        // --- 相簿與照片操作 ---
        function openAlbum(id) {
            currentAlbum = albumsData.find(a => a.id === id);
            if (!currentAlbum) return;

            document.getElementById('albumListView').classList.add('hidden');
            document.getElementById('photoDetailView').classList.remove('hidden');
            document.getElementById('albumTitleDisplay').innerText = currentAlbum.name;
            document.getElementById('currentAlbumName').innerText = currentAlbum.name;

            const grid = document.getElementById('photoGrid');
            grid.innerHTML = '';
            const isAdmin = !!sessionStorage.getItem(SESSION_KEY_ADMIN);
            
            currentAlbum.photos.forEach((photo, index) => {
                const div = document.createElement('div');
                div.className = 'photo-item';
                div.innerHTML = `
                    <img src="${photo.url}" onclick="openLightbox(${index})" loading="lazy">
                    ${isAdmin ? `<div class="admin-controls"><button class="btn btn-link btn-sm text-danger p-0" onclick="deletePhoto('${photo.id}', event)"><i class="bi bi-trash-fill"></i></button></div>` : ''}
                `;
                grid.appendChild(div);
            });
            window.scrollTo(0, 0);
        }

        function showAlbumList() {
            currentAlbum = null;
            document.getElementById('albumListView').classList.remove('hidden');
            document.getElementById('photoDetailView').classList.add('hidden');
        }

        // --- 管理功能 ---
        async function toggleAdmin() {
            const storedPwd = sessionStorage.getItem(SESSION_KEY_ADMIN);
            if (storedPwd) {
                sessionStorage.removeItem(SESSION_KEY_ADMIN);
                Toast.fire({ icon: 'info', title: '已登出管理模式' });
                checkAdminState();
                renderAlbums();
            } else {
                const { value: password } = await Swal.fire({
                    title: '管理登入',
                    input: 'password',
                    inputPlaceholder: '請輸入密碼',
                    showCancelButton: true
                });
                
                if (password) {
                    showLoading(true, "驗證中...");
                    try {
                        const response = await fetch(`${SCRIPT_URL}?action=verifyAdmin&password=${encodeURIComponent(password)}`);
                        const res = await response.json();
                        if (res.status === "success") {
                            sessionStorage.setItem(SESSION_KEY_ADMIN, password);
                            Toast.fire({ icon: 'success', title: '登入成功' });
                            checkAdminState();
                            renderAlbums();
                        } else {
                            Swal.fire("失敗", "密碼錯誤", "error");
                        }
                    } catch (e) {
                        Swal.fire("錯誤", "API 連線失敗", "error");
                    } finally {
                        showLoading(false);
                    }
                }
            }
        }

        function checkAdminState() {
            const isAdmin = !!sessionStorage.getItem(SESSION_KEY_ADMIN);
            const btn = document.getElementById('adminLoginBtn');
            btn.classList.toggle('btn-primary', isAdmin);
            document.getElementById('adminActionHeader').classList.toggle('hidden', !isAdmin);
            document.getElementById('albumAdminButtons').classList.toggle('hidden', !isAdmin);
        }

        async function createNewAlbum() {
            const password = sessionStorage.getItem(SESSION_KEY_ADMIN);
            const { value: name } = await Swal.fire({
                title: '建立新相簿',
                input: 'text',
                inputLabel: '相簿名稱',
                showCancelButton: true
            });
            if (!name) return;

            showLoading(true, "建立相簿中...");
            try {
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // 處理 GAS CORS 限制
                    body: JSON.stringify({ action: "createAlbum", albumName: name, password: password })
                });
                // 因為 no-cors 無法讀取內容，等三秒後自動重新整理
                setTimeout(() => fetchAlbums(true), 3000);
            } catch (e) {
                Swal.fire("提示", "指令已發送，請等待快取更新", "info");
            }
        }

        // --- 上傳邏輯 ---
        function triggerUpload() { document.getElementById('fileInput').click(); }

        async function handleFileSelect(event) {
            const files = event.target.files;
            if (!files.length) return;
            const password = sessionStorage.getItem(SESSION_KEY_ADMIN);
            
            showLoading(true, `準備上傳 0/${files.length}...`);
            
            for (let i = 0; i < files.length; i++) {
                document.getElementById('loadingText').innerText = `正在上傳 (${i+1}/${files.length}): ${files[i].name}`;
                try {
                    const base64 = await toBase64(files[i]);
                    await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({
                            action: "upload",
                            password: password,
                            albumId: currentAlbum.id,
                            albumName: currentAlbum.name,
                            fileName: files[i].name,
                            image: base64
                        })
                    });
                } catch (e) {
                    console.error("上傳失敗", e);
                }
            }
            
            Swal.fire("完成", "檔案已發送上傳請求，約 10 秒後重新整理", "success");
            setTimeout(() => fetchAlbums(true), 5000);
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        async function deletePhoto(fileId, event) {
            event.stopPropagation();
            const password = sessionStorage.getItem(SESSION_KEY_ADMIN);
            const conf = await Swal.fire({ title: '確定刪除？', text: "刪除後無法還原", icon: 'warning', showCancelButton: true });
            if (!conf.isConfirmed) return;

            showLoading(true, "刪除中...");
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ action: "deletePhoto", id: fileId, password: password })
                });
                setTimeout(() => fetchAlbums(true), 3000);
            } catch (e) {
                showLoading(false);
            }
        }

        // --- 燈箱控制 ---
        function openLightbox(index) {
            currentPhotoIndex = index;
            updateLightbox();
            new bootstrap.Modal(document.getElementById('imageModal')).show();
        }

        function updateLightbox() {
            const photo = currentAlbum.photos[currentPhotoIndex];
            document.getElementById('lightboxImg').src = photo.url;
        }

        function navigateLightbox(dir) {
            currentPhotoIndex += dir;
            if (currentPhotoIndex < 0) currentPhotoIndex = currentAlbum.photos.length - 1;
            if (currentPhotoIndex >= currentAlbum.photos.length) currentPhotoIndex = 0;
            updateLightbox();
        }

        // --- 系統設定 ---
        function openSettingsModal() {
            document.getElementById('scriptUrlInput').value = SCRIPT_URL || "";
            new bootstrap.Modal(document.getElementById('settingsModal')).show();
        }

        function saveSettings() {
            const val = document.getElementById('scriptUrlInput').value.trim();
            if (val) {
                localStorage.setItem(STORAGE_KEY, val);
                location.reload();
            }
        }

        function showLoading(show, text = "處理中...") {
            const el = document.getElementById('loadingOverlay');
            document.getElementById('loadingText').innerText = text;
            show ? el.classList.remove('hidden') : el.classList.add('hidden');
        }

        function showSetupState() {
            document.getElementById('setupState').classList.remove('hidden');
            document.getElementById('albumListView').classList.add('hidden');
        }
    </script>
</body>
</html>
