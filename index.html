<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雲端相簿 OLED</title>
    
    <!-- Typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        :root {
            --bg-primary: #000000;
            --bg-secondary: #0D0D0D;
            --bg-tertiary: #1A1A1A;
            --text-primary: #FFFFFF;
            --text-secondary: #F0F0F0; /* 提升亮度 */
            --text-muted: #B0B0B0;    /* 顯著提升對比度 (原本為 #888888) */
            --brand-primary: #448AFF; /* 調亮品牌藍 */
            --brand-accent: #FF4081;
            --info-light: #80D8FF;    /* 提示專用淺藍 */
            --border-subtle: rgba(68, 138, 255, 0.35);
            --glow-blue: 0 0 30px rgba(68, 138, 255, 0.4);
            --font-sans: 'Inter', 'Microsoft JhengHei', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --radius-md: 12px;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-sans);
            min-height: 100vh;
            display: flex; flex-direction: column;
            background-image: radial-gradient(rgba(68, 138, 255, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        .navbar-custom {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-subtle);
            padding: 1rem 0;
            position: sticky; top: 0; z-index: 1020;
        }
        .navbar-brand { font-weight: 700; color: var(--text-primary) !important; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
        .brand-dot { width: 8px; height: 8px; background-color: var(--brand-primary); border-radius: 50%; box-shadow: 0 0 10px var(--brand-primary); }

        .btn-oled {
            background: transparent; border: 1px solid var(--border-subtle); color: var(--text-secondary);
            font-family: var(--font-mono); font-size: 0.85rem; border-radius: var(--radius-md);
            padding: 0.5rem 1rem; transition: all 0.3s; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .btn-oled:hover { border-color: var(--brand-primary); color: var(--text-primary); box-shadow: var(--glow-blue); background: rgba(68, 138, 255, 0.1); }
        .btn-oled-accent { border-color: rgba(255, 64, 129, 0.5); color: var(--brand-accent); }
        .btn-oled-danger { border-color: #FF5252; color: #FF5252; }
        .btn-oled-danger:hover { background: rgba(255, 82, 82, 0.15); border-color: #FF5252; color: #fff; }

        .album-card {
            background-color: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-md);
            overflow: hidden; transition: all 0.3s; height: 100%; display: flex; flex-direction: column; position: relative;
        }
        .album-card:hover { transform: translateY(-4px); border-color: var(--brand-primary); box-shadow: var(--glow-blue); }
        .album-cover { height: 220px; width: 100%; object-fit: cover; border-bottom: 1px solid var(--border-subtle); cursor: pointer; }
        .album-info { padding: 1.2rem; flex-grow: 1; cursor: pointer; }

        .breadcrumb-item-custom { font-family: var(--font-mono); font-size: 0.95rem; color: var(--text-muted); cursor: pointer; text-decoration: none; font-weight: 500; }
        .breadcrumb-item-custom:hover { color: var(--text-primary); }
        .breadcrumb-active { color: var(--brand-primary); font-weight: 700; }

        .modal-content { background-color: var(--bg-secondary); border: 1px solid var(--border-subtle); box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        .modal-header { border-bottom: 1px solid rgba(255,255,255,0.05); }
        .form-control { background-color: var(--bg-tertiary); border: 1px solid var(--border-subtle); color: var(--text-primary); }
        .form-control:focus { background-color: var(--bg-tertiary); border-color: var(--brand-primary); color: var(--text-primary); box-shadow: none; }
        .form-label { color: var(--text-secondary); font-weight: 500; }
        .form-text { color: var(--text-muted) !important; }
        
        /* 提升分享區塊對比 */
        .share-box { background: rgba(68, 138, 255, 0.05); border-radius: 8px; padding: 20px; border: 1px dashed var(--brand-primary); }
        #qrcode img { margin: 0 auto; border: 8px solid white; border-radius: 4px; }
        .text-info-contrast { color: var(--info-light); font-weight: 500; }

        .hidden { display: none !important; }
        .swal2-popup { background: var(--bg-secondary) !important; color: white !important; border: 1px solid var(--border-subtle) !important; }
    </style>
</head>
<body>

    <nav class="navbar navbar-custom">
        <div class="container-fluid px-lg-5">
            <a class="navbar-brand" href="#" onclick="showAlbumList()">
                <span class="brand-dot"></span>
                <span id="navbarTitle">雲端相簿</span>
            </a>
            <div class="d-flex align-items-center gap-2">
                <span id="adminBadge" class="d-none" style="color: var(--brand-accent); font-family: var(--font-mono); font-size: 0.85rem; border: 1px solid var(--brand-accent); padding: 4px 14px; border-radius: 20px; font-weight: 600;">
                    <i class="bi bi-shield-check"></i> 管理者模式
                </span>
                <div id="adminControls" class="d-none d-flex gap-2">
                    <button class="btn-oled btn-sm" onclick="openSettingsModal()" title="系統設定"><i class="bi bi-gear-fill"></i></button>
                    <button class="btn-oled btn-sm btn-oled-danger" onclick="logoutAdmin()" title="登出系統"><i class="bi bi-box-arrow-right"></i></button>
                </div>
                <button id="loginBtn" class="btn-oled btn-oled-accent" onclick="openLoginModal()" title="管理者登入"><i class="bi bi-key-fill"></i></button>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-lg-5 py-5">
        <div id="navHeader" class="mb-4">
            <span class="breadcrumb-item-custom" onclick="showAlbumList()">相簿首頁</span>
            <span id="separator" class="mx-2 text-white hidden">//</span>
            <span id="currentAlbumName" class="breadcrumb-item-custom breadcrumb-active hidden"></span>
        </div>

        <div id="albumView" class="row g-4">
            <div id="loadingText" class="text-center py-5">
                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
                <p class="text-light fs-5">正在從雲端載入資料，請稍候...</p>
            </div>
        </div>
        <div id="photoView" class="row g-3 hidden"></div>
        
        <div id="setupState" class="text-center py-5 hidden">
            <h1 class="display-5 mb-3 fw-bold" style="color: var(--brand-primary);">系統尚未初始化</h1>
            <p class="text-secondary fs-5 mb-4">目前沒有設定 API 服務端點，系統無法正常運作。</p>
            <button class="btn-oled btn-oled-accent px-5 py-3 fs-6" onclick="openSettingsModal()">
                <i class="bi bi-tools me-2"></i>前往設定介面
            </button>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-body p-4 text-center">
                    <i class="bi bi-lock-fill display-5 text-primary mb-3"></i>
                    <h5 class="mb-4 fw-bold">管理者登入</h5>
                    <input type="password" class="form-control text-center mb-4 py-2 fs-5" id="adminPassword" placeholder="請輸入登入密碼">
                    <button class="btn-oled w-100 py-2 fs-6" onclick="verifyAdmin()">驗證並登入</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings & Share Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold"><i class="bi bi-sliders me-2 text-primary"></i>系統設定與分享</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Config Section -->
                    <div class="mb-4">
                        <label class="form-label mb-2">後端 API 端點 (GAS 部署網址)</label>
                        <input type="url" class="form-control" id="settingGasUrl" placeholder="https://script.google.com/macros/s/...">
                        <div class="form-text mt-2 text-info-contrast">※ 由 Google Apps Script 部署生成的執行網址。</div>
                    </div>
                    <div class="mb-4">
                        <label class="form-label mb-2">相簿顯示標題</label>
                        <input type="text" class="form-control" id="settingPageTitle">
                    </div>
                    
                    <hr class="my-4 opacity-25">

                    <!-- Share Section -->
                    <div class="mb-2">
                        <label class="form-label mb-3"><i class="bi bi-qr-code-scan me-1"></i> 家長專用分享資訊</label>
                        <div class="share-box text-center">
                            <div id="qrcode" class="mb-4 d-flex justify-content-center"></div>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control bg-dark border-secondary text-light fs-7" id="shareUrlInput" readonly style="font-size: 0.8rem;">
                                <button class="btn btn-primary px-3" onclick="copyShareUrl()">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                            <div class="text-info-contrast small">
                                <i class="bi bi-lightbulb-fill me-1"></i>掃描 QR Code 後，系統將自動套用您的 API 設定，家長可直接瀏覽相簿。
                            </div>
                        </div>
                    </div>

                    <button class="btn-oled w-100 btn-oled-accent mt-4 py-3 fw-bold" onclick="saveSettings()">
                        <i class="bi bi-save2 me-2"></i>儲存並重新整理頁面
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let SCRIPT_URL = localStorage.getItem('gas_api_url') || "";
        let PAGE_TITLE = localStorage.getItem('page_title') || "雲端相簿";
        let isAdmin = localStorage.getItem('is_admin') === 'true';

        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const encodedUrl = urlParams.get('api');
            if (encodedUrl) {
                try {
                    const decodedUrl = atob(encodedUrl);
                    localStorage.setItem('gas_api_url', decodedUrl);
                    Swal.fire({
                        icon: 'success',
                        title: '自動設定成功',
                        text: '正在啟動相簿服務...',
                        timer: 2000,
                        showConfirmButton: false,
                        background: '#0D0D0D',
                        color: '#FFFFFF'
                    }).then(() => {
                        window.history.replaceState({}, document.title, window.location.pathname);
                        location.reload();
                    });
                    return;
                } catch(e) { console.error("API 解析失敗"); }
            }

            document.getElementById('navbarTitle').innerText = PAGE_TITLE;
            updateAdminUi();

            if (!SCRIPT_URL) {
                document.getElementById('loadingText').classList.add('hidden');
                document.getElementById('setupState').classList.remove('hidden');
                setTimeout(openSettingsModal, 800);
            } else {
                fetchAlbums();
                initShareInfo();
            }
        });

        function initShareInfo() {
            if (!SCRIPT_URL) return;
            const baseUrl = window.location.href.split('?')[0];
            const shareUrl = `${baseUrl}?api=${btoa(SCRIPT_URL)}`;
            document.getElementById('shareUrlInput').value = shareUrl;
            
            const qrContainer = document.getElementById("qrcode");
            qrContainer.innerHTML = "";
            new QRCode(qrContainer, {
                text: shareUrl,
                width: 180,
                height: 180,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }

        function copyShareUrl() {
            const input = document.getElementById('shareUrlInput');
            navigator.clipboard.writeText(input.value).then(() => {
                Swal.fire({ 
                    icon: 'success', 
                    title: '複製成功', 
                    text: '請將此網址分享給家長瀏覽', 
                    timer: 1500, 
                    showConfirmButton: false,
                    background: '#0D0D0D',
                    color: '#FFFFFF'
                });
            });
        }

        async function fetchAlbums() {
            try {
                const res = await fetch(`${SCRIPT_URL}?action=getAlbums`);
                const result = await res.json();
                if (result.status === "success") {
                    renderAlbums(result.data);
                } else {
                    Swal.fire('存取失敗', '後端 API 回傳錯誤，請檢查設定。', 'error');
                }
            } catch (e) {
                console.error(e);
                document.getElementById('loadingText').innerHTML = `
                    <div class="p-4 border border-danger rounded d-inline-block">
                        <i class="bi bi-exclamation-triangle text-danger fs-1"></i>
                        <p class="text-danger mt-3">連線失敗：無法聯繫上雲端 API 服務。<br>請檢查 API 網址是否正確或 Google 服務是否已部署。</p>
                        <button class="btn btn-outline-danger btn-sm mt-2" onclick="openSettingsModal()">修改 API 設定</button>
                    </div>`;
            }
        }

        function renderAlbums(data) {
            const container = document.getElementById('albumView');
            container.innerHTML = '';
            
            if (!data || data.length === 0) {
                container.innerHTML = `<div class="text-center py-5 w-100"><p class="text-muted fs-5">目前沒有任何相簿內容。</p></div>`;
                return;
            }

            data.forEach(album => {
                const div = document.createElement('div');
                div.className = 'col-12 col-md-6 col-lg-4 col-xl-3';
                div.innerHTML = `
                    <div class="album-card" onclick="openAlbum('${album.id}', '${album.name}', ${JSON.stringify(album.photos).replace(/"/g, '&quot;')})">
                        <img src="${album.cover || 'https://via.placeholder.com/400x220/111/fff?text=No+Cover'}" class="album-cover" alt="${album.name}">
                        <div class="album-info">
                            <div class="fw-bold mb-1 text-truncate text-white" style="font-size: 1.1rem;">${album.name}</div>
                            <div class="text-muted font-monospace">${album.photos.length} 張相片</div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function openAlbum(id, name, photos) {
            document.getElementById('albumView').classList.add('hidden');
            document.getElementById('photoView').classList.remove('hidden');
            document.getElementById('separator').classList.remove('hidden');
            document.getElementById('currentAlbumName').classList.remove('hidden');
            document.getElementById('currentAlbumName').innerText = name;

            const container = document.getElementById('photoView');
            container.innerHTML = '';
            
            if (!photos || photos.length === 0) {
                container.innerHTML = `<div class="text-center py-5 w-100"><p class="text-muted fs-5">相簿內目前沒有相片。</p></div>`;
                return;
            }

            photos.forEach(p => {
                const col = document.createElement('div');
                col.className = 'col-6 col-md-4 col-lg-2';
                col.innerHTML = `
                    <div class="photo-item" onclick="window.open('${p.url}', '_blank')">
                        <img src="${p.url}" class="w-100 rounded border border-secondary" loading="lazy" alt="相片">
                    </div>
                `;
                container.appendChild(col);
            });
        }

        function showAlbumList() {
            document.getElementById('albumView').classList.remove('hidden');
            document.getElementById('photoView').classList.add('hidden');
            document.getElementById('separator').classList.add('hidden');
            document.getElementById('currentAlbumName').classList.add('hidden');
        }

        async function verifyAdmin() {
            const pwd = document.getElementById('adminPassword').value;
            if (!pwd) return;

            try {
                const res = await fetch(`${SCRIPT_URL}?action=verifyAdmin&password=${pwd}`);
                const result = await res.json();
                if (result.status === "success") {
                    isAdmin = true;
                    localStorage.setItem('is_admin', 'true');
                    updateAdminUi();
                    const modalEl = document.getElementById('loginModal');
                    bootstrap.Modal.getInstance(modalEl).hide();
                    Swal.fire({ 
                        icon: 'success', 
                        title: '登入成功', 
                        text: '管理員模式已啟用', 
                        timer: 1500, 
                        showConfirmButton: false,
                        background: '#0D0D0D',
                        color: '#FFFFFF'
                    });
                } else {
                    Swal.fire({ icon: 'error', title: '登入失敗', text: '管理者密碼錯誤', background: '#0D0D0D', color: '#FFFFFF' });
                }
            } catch (e) {
                Swal.fire({ icon: 'error', title: '連線錯誤', text: '請檢查 API 網址是否正確。', background: '#0D0D0D', color: '#FFFFFF' });
            }
        }

        function logoutAdmin() {
            isAdmin = false;
            localStorage.removeItem('is_admin');
            updateAdminUi();
            Swal.fire({
                icon: 'success',
                title: '已退出管理模式',
                text: '歡迎隨時回來！',
                timer: 1500,
                showConfirmButton: false,
                background: '#0D0D0D',
                color: '#FFFFFF'
            });
        }

        function updateAdminUi() {
            const badge = document.getElementById('adminBadge');
            const controls = document.getElementById('adminControls');
            const loginBtn = document.getElementById('loginBtn');
            if (isAdmin) {
                badge.classList.remove('d-none');
                controls.classList.remove('d-none');
                loginBtn.classList.add('d-none');
            } else {
                badge.classList.add('d-none');
                controls.classList.add('d-none');
                loginBtn.classList.remove('d-none');
            }
        }

        function saveSettings() {
            const url = document.getElementById('settingGasUrl').value.trim();
            const title = document.getElementById('settingPageTitle').value.trim();
            if(!url) return Swal.fire({ icon: 'warning', title: '請輸入 API 網址', background: '#0D0D0D', color: '#FFFFFF' });
            
            localStorage.setItem('gas_api_url', url);
            localStorage.setItem('page_title', title || "雲端相簿");
            
            Swal.fire({ 
                icon: 'success', 
                title: '儲存完成', 
                text: '系統即將重新載入內容',
                timer: 1200, 
                showConfirmButton: false,
                background: '#0D0D0D',
                color: '#FFFFFF'
            }).then(() => location.reload());
        }

        function openLoginModal() { 
            document.getElementById('adminPassword').value = "";
            new bootstrap.Modal(document.getElementById('loginModal')).show(); 
        }
        function openSettingsModal() { 
            document.getElementById('settingGasUrl').value = SCRIPT_URL;
            document.getElementById('settingPageTitle').value = PAGE_TITLE;
            initShareInfo();
            new bootstrap.Modal(document.getElementById('settingsModal')).show(); 
        }
    </script>
</body>
</html>
