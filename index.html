<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雲端相簿 OLED</title>
    
    <!-- Typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* --- S92 OLED Style Tokens --- */
        :root {
            --bg-primary: #000000;
            --bg-secondary: #0A0A0A;
            --bg-tertiary: #111111;
            --text-primary: #FFFFFF;
            --text-secondary: #E0E0E0;
            --text-muted: #888888;
            --brand-primary: #2979FF;
            --brand-accent: #FF4081;
            --brand-success: #00E676;
            --brand-danger: #FF1744;
            --border-subtle: rgba(41, 121, 255, 0.2);
            --glow-blue: 0 0 30px rgba(41, 121, 255, 0.3);
            --font-sans: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --radius-md: 12px;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-sans);
            min-height: 100vh;
            display: flex; flex-direction: column;
            background-image: radial-gradient(rgba(41, 121, 255, 0.15) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        /* Navbar */
        .navbar-custom {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-subtle);
            padding: 1.2rem 0;
            position: sticky; top: 0; z-index: 1000;
        }
        .navbar-brand { font-weight: 700; color: var(--text-primary) !important; display: flex; align-items: center; gap: 0.5rem; }
        .brand-dot { width: 8px; height: 8px; background-color: var(--brand-primary); border-radius: 50%; box-shadow: 0 0 10px var(--brand-primary); }

        /* Buttons */
        .btn-oled {
            background: transparent; border: 1px solid var(--border-subtle); color: var(--text-secondary);
            font-family: var(--font-mono); font-size: 0.85rem; border-radius: var(--radius-md);
            padding: 0.6rem 1.2rem; transition: all 0.3s; text-decoration: none;
        }
        .btn-oled:hover { border-color: var(--brand-primary); color: var(--text-primary); box-shadow: var(--glow-blue); background: rgba(41, 121, 255, 0.05); text-decoration: none; }
        .btn-oled-accent { border-color: rgba(255, 64, 129, 0.3); }
        .btn-oled-accent:hover { border-color: var(--brand-accent); background: rgba(255, 64, 129, 0.05); text-decoration: none; }
        .btn-oled-danger { border-color: var(--brand-danger); color: var(--brand-danger); }
        .btn-oled-danger:hover { background: rgba(255, 23, 68, 0.1); box-shadow: 0 0 15px rgba(255, 23, 68, 0.3); text-decoration: none; }
        .btn-icon { width: 44px; height: 44px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 1.2rem; }

        /* Cards */
        .album-card {
            background-color: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-md);
            overflow: hidden; transition: all 0.3s; cursor: pointer; height: 100%; display: flex; flex-direction: column;
        }
        .album-card:hover { transform: translateY(-4px); border-color: var(--brand-primary); box-shadow: var(--glow-blue); }
        .album-cover { height: 240px; width: 100%; object-fit: cover; border-bottom: 1px solid var(--border-subtle); }
        .album-info { padding: 1.5rem; flex-grow: 1; }
        .album-title { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; }
        .album-meta { font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-muted); }

        /* Photo Grid */
        .photo-item { position: relative; border-radius: var(--radius-md); overflow: hidden; aspect-ratio: 1/1; border: 1px solid transparent; cursor: pointer; }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
        .photo-item:hover { border-color: var(--brand-primary); }
        .photo-item:hover img { transform: scale(1.05); }

        /* Inputs & Modals */
        .modal-content { background-color: var(--bg-secondary); border: 1px solid var(--border-subtle); box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .modal-header, .modal-footer { border-color: var(--border-subtle); }
        .modal-title { color: var(--text-primary); font-weight: bold; }
        .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
        .form-control, .form-select { background-color: var(--bg-tertiary); border: 1px solid var(--border-subtle); color: var(--text-primary); padding: 0.8rem; }
        .form-control:focus, .form-select:focus { background-color: var(--bg-tertiary); border-color: var(--brand-primary); color: var(--text-primary); box-shadow: none; }
        .form-label { color: var(--text-secondary); font-size: 0.9rem; }

        /* Footer */
        .footer-custom { margin-top: auto; border-top: 1px solid var(--border-subtle); padding: 2rem 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); text-align: center; }
        .footer-text { font-family: var(--font-mono); color: var(--text-muted); font-size: 0.8rem; letter-spacing: 0.05em; }

        /* Tabs in Admin Modal */
        .nav-tabs { border-bottom: 1px solid var(--border-subtle); }
        .nav-tabs .nav-link { color: var(--text-muted); border: none; border-bottom: 2px solid transparent; transition: 0.3s; font-family: var(--font-mono); cursor: pointer; }
        .nav-tabs .nav-link:hover { color: var(--text-primary); }
        .nav-tabs .nav-link.active { background: transparent; color: var(--brand-primary); border-bottom: 2px solid var(--brand-primary); }

        /* Admin Styles */
        .progress-container { height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden; margin-top: 1rem; }
        .progress-bar { height: 100%; background: var(--brand-accent); width: 0%; transition: width 0.3s; }
        .log-area { font-family: var(--font-mono); font-size: 0.8rem; color: var(--text-muted); max-height: 150px; overflow-y: auto; margin-top: 1rem; background: #000; padding: 10px; border: 1px solid var(--border-subtle); }

        /* Directory List */
        .directory-list { list-style: none; padding: 0; margin: 0; max-height: 60vh; overflow-y: auto; }
        .directory-item { padding: 1rem; border-bottom: 1px solid var(--border-subtle); cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .directory-item:hover { background: rgba(41, 121, 255, 0.1); padding-left: 1.5rem; color: var(--brand-primary); }
        .directory-item:last-child { border-bottom: none; }
        .dir-index { font-family: var(--font-mono); color: var(--text-muted); font-size: 0.8rem; margin-right: 1rem; }
        .dir-count { font-family: var(--font-mono); background: var(--bg-tertiary); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }

        /* Utils */
        .hidden { display: none !important; }
        .d-none { display: none !important; }
        
        /* Lightbox */
        #imageModal .modal-content { background: rgba(0,0,0,0.95); border: none; }
        #previewImage { max-height: calc(100vh - 160px); max-width: 90vw; }
        .lightbox-nav-btn { position: absolute; top: 50%; transform: translateY(-50%); width: 56px; height: 56px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; background: rgba(0,0,0,0.5); z-index: 1060; }
        .lightbox-prev { left: 20px; } .lightbox-next { right: 20px; }
        .thumbnail-strip-container { position: absolute; bottom: 0; width: 100%; height: 100px; background: rgba(0,0,0,0.8); display: flex; align-items: center; padding: 0 20px; overflow-x: auto; }
        .thumb-item { width: 60px; height: 60px; margin-right: 10px; opacity: 0.5; cursor: pointer; flex-shrink: 0; }
        .thumb-item.active { opacity: 1; border: 2px solid var(--brand-primary); }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar navbar-custom">
        <div class="container-fluid px-lg-5">
            <a class="navbar-brand" href="#">
                <span class="brand-dot"></span>
                <span id="navbarTitle">雲端相簿</span>
            </a>
            <div>
                <!-- Viewer Mode Label (Shown only via share link) -->
                <span id="viewerModeLabel" class="d-none user-select-none me-2" style="color: var(--brand-success); font-family: var(--font-mono); font-size: 0.8rem; border: 1px solid var(--brand-success); padding: 6px 12px; border-radius: 20px;">
                    <i class="bi bi-eye-fill me-1"></i> 瀏覽模式
                </span>
                
                <!-- Admin Login Button (Key Icon) -->
                <button class="btn-oled btn-icon btn-oled-accent btn-settings" onclick="openLoginModal()" title="管理者登入">
                    <i class="bi bi-key-fill"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid px-lg-5 py-5">
        
        <!-- Admin Dashboard (Hidden by default) -->
        <div id="adminView" class="admin-panel hidden">
            <div class="admin-badge">ADMIN_CONSOLE</div>
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0">上傳管理後台</h4>
                <button class="btn-oled btn-sm" onclick="logoutAdmin()">登出</button>
            </div>
            
            <div class="row g-4">
                <div class="col-md-4">
                    <label class="form-label">選擇或建立相簿</label>
                    <div class="input-group mb-2">
                        <select class="form-select" id="uploadAlbumSelect" onchange="handleAlbumSelect()">
                            <option value="new">+ 建立新相簿...</option>
                            <!-- Existing albums populated via JS -->
                        </select>
                    </div>
                    <input type="text" class="form-control hidden" id="newAlbumName" placeholder="輸入新相簿名稱 (例如: 1130520 校慶)">
                </div>
                <div class="col-md-8">
                    <label class="form-label">選擇照片 (支援多選)</label>
                    <input type="file" class="form-control" id="uploadFiles" multiple accept="image/*">
                </div>
            </div>
            
            <div class="d-flex justify-content-end mt-4">
                <button id="startUploadBtn" class="btn-oled btn-oled-accent px-4" onclick="startBatchUpload()">
                    <i class="bi bi-cloud-upload me-2"></i> 開始上傳
                </button>
            </div>

            <!-- Upload Status -->
            <div id="uploadStatus" class="hidden">
                <div class="progress-container">
                    <div id="uploadProgressBar" class="progress-bar"></div>
                </div>
                <div class="d-flex justify-content-between mt-2 font-monospace small text-muted">
                    <span id="uploadProgressText">準備中...</span>
                    <span id="uploadCount">0/0</span>
                </div>
                <div id="uploadLog" class="log-area"></div>
            </div>
        </div>

        <!-- Navigation Header -->
        <div id="navHeader" class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-4">
            <div>
                <span id="homeLink" class="breadcrumb-item-custom" onclick="showAlbumList()">相簿首頁</span>
                <span id="separator" class="breadcrumb-separator hidden">//</span>
                <span id="currentAlbumName" class="breadcrumb-item-custom breadcrumb-active hidden"></span>
            </div>
            <div class="d-flex gap-2">
                <button id="directoryBtn" class="btn-oled" onclick="openDirectoryModal()"><i class="bi bi-list-ul me-2"></i> 目錄檢索</button>
                <button id="downloadAllBtn" class="btn-oled btn-oled-accent hidden" onclick="downloadAllCurrentPhotos()"><i class="bi bi-download me-2"></i> 相簿下載</button>
                <button id="refreshBtn" class="btn-oled" onclick="fetchAlbums(true)"><i class="bi bi-arrow-clockwise"></i></button>
            </div>
        </div>

        <!-- Views -->
        <div id="albumView" class="row g-4"></div>
        <div id="photoView" class="row g-3 hidden"></div>
        <div id="emptyState" class="text-center py-5 hidden"><h2 class="text-muted font-monospace">查無資料 (NO_DATA)</h2></div>
        
        <!-- Initial Setup State -->
        <div id="setupState" class="text-center py-5 hidden">
            <h1 class="display-4 mb-3">系統初始化</h1>
            <p class="text-muted">尚未設定服務端點。</p>
            <button class="btn-oled btn-oled-accent px-5" onclick="openAdminDashboard('settings')">開始設定</button>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer-custom">
        <div class="container">
            <span class="footer-text">© 新北市崇德國小 | All Rights Reserved.</span>
        </div>
    </footer>

    <!-- Modals -->

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header border-0"><h5 class="modal-title">管理者驗證</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <!-- Added autocomplete="off" to prevent retention -->
                    <input type="password" class="form-control text-center mb-3" id="adminPassword" placeholder="請輸入密碼" autocomplete="off">
                    <button class="btn-oled w-100" onclick="verifyAdmin()">登入</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard Modal (Unified) -->
    <div class="modal fade" id="adminDashboardModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-shield-lock-fill me-2"></i>管理者後台</h5>
                    <div class="d-flex gap-2">
                        <!-- Logout Button -->
                        <button type="button" class="btn-oled btn-sm btn-oled-danger" onclick="logoutAdmin()">
                            <i class="bi bi-box-arrow-right me-1"></i> 登出
                        </button>
                    </div>
                </div>
                <div class="modal-body p-0">
                    <!-- Tabs -->
                    <ul class="nav nav-tabs nav-fill" id="adminTabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" id="tab-upload" data-bs-toggle="tab" data-bs-target="#content-upload" type="button">相簿上傳</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="tab-settings" data-bs-toggle="tab" data-bs-target="#content-settings" type="button">系統設定</button>
                        </li>
                    </ul>
                    
                    <!-- Tab Content -->
                    <div class="tab-content p-4">
                        <!-- Upload Tab -->
                        <div class="tab-pane fade show active" id="content-upload">
                            <div class="row g-4">
                                <div class="col-md-5">
                                    <label class="form-label">選擇或建立相簿</label>
                                    <select class="form-select mb-2" id="uploadAlbumSelect" onchange="handleAlbumSelect()">
                                        <option value="new">+ 建立新相簿...</option>
                                    </select>
                                    <input type="text" class="form-control hidden" id="newAlbumName" placeholder="輸入名稱 (例: 1130520 校慶)">
                                </div>
                                <div class="col-md-7">
                                    <label class="form-label">選擇照片</label>
                                    <input type="file" class="form-control" id="uploadFiles" multiple accept="image/*">
                                </div>
                            </div>
                            <div class="d-flex justify-content-end mt-4">
                                <button id="startUploadBtn" class="btn-oled btn-oled-accent px-4" onclick="startBatchUpload()">
                                    <i class="bi bi-cloud-upload me-2"></i> 開始上傳
                                </button>
                            </div>
                            <!-- Upload Progress -->
                            <div id="uploadStatus" class="hidden mt-3">
                                <div class="progress-container"><div id="uploadProgressBar" class="progress-bar"></div></div>
                                <div class="d-flex justify-content-between mt-2 font-monospace small text-muted">
                                    <span id="uploadProgressText">準備中...</span><span id="uploadCount">0/0</span>
                                </div>
                                <div id="uploadLog" class="log-area"></div>
                            </div>
                        </div>

                        <!-- Settings Tab -->
                        <div class="tab-pane fade" id="content-settings">
                            <div class="mb-3">
                                <label class="form-label font-monospace">API服務端點 (GAS URL)</label>
                                <input type="url" class="form-control" id="settingGasUrl" placeholder="https://script.google.com/...">
                            </div>
                            <div class="mb-4">
                                <label class="form-label font-monospace">網頁標題</label>
                                <input type="text" class="form-control" id="settingPageTitle" placeholder="我的雲端相簿">
                            </div>
                            
                            <button class="btn-oled w-100 mb-4" onclick="saveSettings()">儲存設定並重啟</button>
                            
                            <hr style="border-color: var(--border-subtle);">
                            
                            <div class="text-center">
                                <p class="text-secondary small font-monospace mb-2">存取 QR CODE (智慧連結)</p>
                                <div id="qrcode" class="d-flex justify-content-center mb-3 bg-white p-2 rounded w-auto d-inline-block"></div>
                                <div class="input-group input-group-sm mb-3">
                                    <input type="text" class="form-control text-center" id="shareLinkInput" readonly>
                                    <button class="btn btn-outline-secondary" onclick="copyShareLink()">複製</button>
                                </div>
                                <p class="small font-monospace mb-4" style="color: var(--brand-accent); font-weight: bold;">
                                    * 此連結已包含您的設定，掃描後可直接存取相簿。
                                </p>
                                <button class="btn-oled btn-oled-danger btn-sm" onclick="clearSettings()">清除本機設定 (Reset App)</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Directory Modal -->
    <div class="modal fade" id="directoryModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">相簿目錄索引</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body p-0"><ul id="directoryList" class="directory-list"></ul></div>
            </div>
        </div>
    </div>

    <!-- Lightbox -->
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-body p-0 d-flex flex-column justify-content-center align-items-center position-relative">
                    <button class="btn-close btn-close-white position-absolute top-0 end-0 m-4 z-3" data-bs-dismiss="modal"></button>
                    <a id="downloadLink" href="#" target="_blank" class="btn-oled position-absolute top-0 start-0 m-4 z-3">照片下載</a>
                    <button class="lightbox-nav-btn lightbox-prev" onclick="navigateLightbox(-1)"><i class="bi bi-chevron-left"></i></button>
                    <button class="lightbox-nav-btn lightbox-next" onclick="navigateLightbox(1)"><i class="bi bi-chevron-right"></i></button>
                    <img id="previewImage" src="" class="img-fluid">
                    <div class="thumbnail-strip-container" id="thumbnailStrip"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div id="loadingOverlay" class="hidden">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3 text-muted font-monospace">系統載入中...</p>
        <button class="btn-oled btn-oled-danger btn-sm mt-3" onclick="forceStopLoading()">終止程序</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let SCRIPT_URL = "";
        let PAGE_TITLE = "雲端相簿";
        let allData = [];
        let currentAlbumPhotos = [];
        let currentAlbumNameStr = "";
        let currentPhotoIndex = 0;
        let adminToken = ""; 

        const STORAGE_KEY_URL = "gas_album_url_v5";
        const STORAGE_KEY_TITLE = "gas_album_title_v5";
        const SESSION_KEY_VIEWER = "is_viewer_mode";

        // Fast UI Toggle
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const ref = urlParams.get('ref');
            if(ref) {
                try {
                    localStorage.setItem(STORAGE_KEY_URL, atob(ref));
                    sessionStorage.setItem(SESSION_KEY_VIEWER, "true");
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch(e){}
            }
            if (sessionStorage.getItem(SESSION_KEY_VIEWER) === "true") {
                const style = document.createElement('style');
                style.innerHTML = '.btn-settings { display: none !important; } #viewerModeLabel { display: inline-block !important; }';
                document.head.appendChild(style);
            }
        })();

        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            
            document.addEventListener('keydown', (e) => {
                if(document.getElementById('imageModal').classList.contains('show')) {
                    if(e.key === "ArrowLeft") navigateLightbox(-1);
                    if(e.key === "ArrowRight") navigateLightbox(1);
                }
            });

            // If no URL, force Setup Mode (which opens Admin Panel Settings)
            if (!SCRIPT_URL) {
                showSetupState();
            } else {
                fetchAlbums();
            }
        });

        // --- Core Functions ---

        async function fetchAlbums(forceRefresh = false) {
            if (!SCRIPT_URL) return;
            showLoading(true);
            try {
                let url = `${SCRIPT_URL}?action=getAlbums`;
                if (forceRefresh) url += "&refresh=true";
                const res = await fetch(url);
                const json = await res.json();
                if (json.status === "success") {
                    allData = json.data;
                    // Sort: Date (8 digits) Desc
                    allData.sort((a, b) => {
                        const getDigits = s => {
                            const d = s.replace(/\D/g, '');
                            return d.length > 0 ? parseInt(d.substring(0, 8), 10) : 0;
                        };
                        const dA = getDigits(a.name||""), dB = getDigits(b.name||"");
                        if(dB !== dA) return dB - dA;
                        return (b.name||"").localeCompare((a.name||""), 'zh-TW');
                    });
                    
                    showAlbumList();
                    populateAdminAlbumSelect();
                } else { throw new Error(json.message); }
            } catch (err) {
                console.error(err);
                showLoading(false);
            } finally { showLoading(false); }
        }

        function showAlbumList() {
            document.getElementById('albumView').classList.remove('hidden');
            document.getElementById('photoView').classList.add('hidden');
            document.getElementById('separator').classList.add('hidden');
            document.getElementById('currentAlbumName').classList.add('hidden');
            document.getElementById('downloadAllBtn').classList.add('hidden');
            document.getElementById('directoryBtn').classList.remove('hidden');
            document.getElementById('setupState').classList.add('hidden');
            
            const view = document.getElementById('albumView');
            view.innerHTML = '';
            if(allData.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            } else {
                document.getElementById('emptyState').classList.add('hidden');
            }

            allData.forEach(album => {
                const col = document.createElement('div');
                col.className = 'col-12 col-md-4 col-lg-3';
                col.innerHTML = `
                    <div class="album-card" onclick="showPhotos('${album.id}')">
                        <img src="${album.cover}" class="album-cover" loading="lazy">
                        <div class="album-info">
                            <h5 class="album-title">${album.name}</h5>
                            <div class="album-meta"><i class="bi bi-images me-1"></i> ${album.photos.length} 項目</div>
                        </div>
                    </div>`;
                view.appendChild(col);
            });
        }

        function showPhotos(albumId) {
            const album = allData.find(a => a.id === albumId);
            if (!album) return;
            currentAlbumPhotos = album.photos;
            currentAlbumNameStr = album.name;

            const dirModal = bootstrap.Modal.getInstance(document.getElementById('directoryModal'));
            if(dirModal) dirModal.hide();

            document.getElementById('albumView').classList.add('hidden');
            document.getElementById('photoView').classList.remove('hidden');
            document.getElementById('downloadAllBtn').classList.remove('hidden');
            document.getElementById('separator').classList.remove('hidden');
            document.getElementById('currentAlbumName').innerText = album.name;
            document.getElementById('currentAlbumName').classList.remove('hidden');

            const view = document.getElementById('photoView');
            view.innerHTML = '';
            album.photos.forEach((photo, index) => {
                const col = document.createElement('div');
                col.className = 'col-6 col-md-3 col-lg-2';
                col.innerHTML = `<div class="photo-item" onclick="openLightbox(${index})"><img src="${photo.url.replace('=s800', '=s400')}" loading="lazy"></div>`;
                view.appendChild(col);
            });
        }

        // --- Admin Functions ---

        function openLoginModal() {
            // Ensure input is empty before showing
            document.getElementById('adminPassword').value = "";
            // Check if initial setup
            if(!SCRIPT_URL) {
                // If no URL, skip login and go straight to settings (initial setup)
                openAdminDashboard('settings');
                return;
            }
            new bootstrap.Modal(document.getElementById('loginModal')).show();
        }

        async function verifyAdmin() {
            const pwd = document.getElementById('adminPassword').value;
            if(!pwd) return alert("請輸入密碼");
            
            showLoading(true);
            try {
                const url = `${SCRIPT_URL}?action=verifyAdmin&password=${encodeURIComponent(pwd)}`;
                const res = await fetch(url);
                const json = await res.json();
                
                if(json.status === "success") {
                    adminToken = pwd;
                    // Clear password after success
                    document.getElementById('adminPassword').value = "";
                    
                    bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
                    openAdminDashboard();
                    alert("登入成功！");
                } else {
                    alert("密碼錯誤");
                }
            } catch(e) {
                alert("驗證失敗: " + e);
            } finally {
                showLoading(false);
            }
        }

        function openAdminDashboard(activeTabId = 'upload') {
            const modal = new bootstrap.Modal(document.getElementById('adminDashboardModal'));
            modal.show();
            
            // Populate settings fields
            document.getElementById('settingGasUrl').value = SCRIPT_URL;
            document.getElementById('settingPageTitle').value = PAGE_TITLE;
            initShareUi(); // update QR in modal
            populateAdminAlbumSelect();

            // Switch Tab
            const triggerEl = document.querySelector(`#adminTabs button[id="tab-${activeTabId}"]`);
            if(triggerEl) bootstrap.Tab.getOrCreateInstance(triggerEl).show();
        }

        function logoutAdmin() {
            adminToken = "";
            // Clear password field to prevent retention
            document.getElementById('adminPassword').value = "";
            const modal = bootstrap.Modal.getInstance(document.getElementById('adminDashboardModal'));
            if(modal) modal.hide();
            alert("已登出"); 
        }

        function populateAdminAlbumSelect() {
            const select = document.getElementById('uploadAlbumSelect');
            select.innerHTML = '<option value="new">+ 建立新相簿...</option>';
            if(allData) {
                allData.forEach(album => {
                    const opt = document.createElement('option');
                    opt.value = album.name;
                    opt.innerText = album.name;
                    select.appendChild(opt);
                });
            }
        }

        function handleAlbumSelect() {
            const val = document.getElementById('uploadAlbumSelect').value;
            const input = document.getElementById('newAlbumName');
            if(val === 'new') {
                input.classList.remove('hidden');
            } else {
                input.classList.add('hidden');
            }
        }

        async function startBatchUpload() {
            if(!adminToken) return alert("憑證過期，請重新登入");
            
            const selectVal = document.getElementById('uploadAlbumSelect').value;
            let albumName = selectVal;
            if(selectVal === 'new') {
                albumName = document.getElementById('newAlbumName').value.trim();
                if(!albumName) return alert("請輸入新相簿名稱");
            }
            
            const files = document.getElementById('uploadFiles').files;
            if(files.length === 0) return alert("請選擇檔案");

            document.getElementById('uploadStatus').classList.remove('hidden');
            const pBar = document.getElementById('uploadProgressBar');
            const pText = document.getElementById('uploadProgressText');
            const pCount = document.getElementById('uploadCount');
            const logArea = document.getElementById('uploadLog');
            
            logArea.innerHTML = "";
            pBar.style.width = "0%";
            
            let successCount = 0;
            const total = files.length;

            for(let i=0; i<total; i++) {
                const file = files[i];
                pText.innerText = `上傳中: ${file.name}`;
                pCount.innerText = `${i+1}/${total}`;
                
                try {
                    const base64 = await toBase64(file);
                    const payload = {
                        password: adminToken,
                        albumName: albumName,
                        fileName: file.name,
                        image: base64
                    };
                    
                    const res = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    
                    const json = await res.json();
                    
                    if(json.status === "success") {
                        successCount++;
                        logLog(file.name + " ... OK");
                    } else {
                        logLog(file.name + " ... FAILED: " + json.message, "red");
                    }

                } catch(e) {
                    console.error(e);
                    logLog(file.name + " ... ERROR", "red");
                }
                
                const pct = Math.round(((i+1)/total)*100);
                pBar.style.width = `${pct}%`;
            }
            
            pText.innerText = "上傳完成";
            alert(`上傳完成！成功 ${successCount} / ${total}`);
            
            document.getElementById('uploadFiles').value = "";
            setTimeout(() => {
                document.getElementById('uploadStatus').classList.add('hidden');
                fetchAlbums(true);
            }, 2000);
        }

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function logLog(msg, color="gray") {
            const div = document.createElement('div');
            div.innerText = msg;
            div.style.color = color;
            const area = document.getElementById('uploadLog');
            area.prepend(div);
        }

        // --- Other Helpers ---

        function openDirectoryModal() {
            if(!allData || allData.length === 0) {
                alert("無資料可顯示");
                return;
            }
            const list = document.getElementById('directoryList');
            list.innerHTML = '';
            allData.forEach((album, i) => {
                const li = document.createElement('li');
                li.className = 'directory-item';
                const num = (i+1).toString().padStart(2,'0');
                li.innerHTML = `
                    <div><span class="dir-index">[${num}]</span> ${album.name}</div>
                    <span class="dir-count">${album.photos.length}</span>`;
                li.onclick = () => { showPhotos(album.id); bootstrap.Modal.getInstance(document.getElementById('directoryModal')).hide(); };
                list.appendChild(li);
            });
            new bootstrap.Modal(document.getElementById('directoryModal')).show();
        }

        function openLightbox(index) {
            currentPhotoIndex = index;
            updateLightbox();
            renderThumbs();
            new bootstrap.Modal(document.getElementById('imageModal')).show();
        }

        function updateLightbox() {
            const p = currentAlbumPhotos[currentPhotoIndex];
            const img = document.getElementById('previewImage');
            img.style.opacity = '0.5';
            const url = p.url.replace('=s800','=s1600').replace('&sz=w800','&sz=w1600');
            const newI = new Image();
            newI.onload = () => { img.src = url; img.style.opacity = '1'; };
            newI.src = url;
            document.getElementById('downloadLink').href = p.downloadUrl;
            
            document.querySelectorAll('.thumb-item').forEach(el => el.classList.remove('active'));
            const active = document.querySelector(`.thumb-item[data-idx="${currentPhotoIndex}"]`);
            if(active) {
                active.classList.add('active');
                active.scrollIntoView({ behavior: 'smooth', inline: 'center' });
            }
        }

        function renderThumbs() {
            const c = document.getElementById('thumbnailStrip');
            c.innerHTML = '';
            currentAlbumPhotos.forEach((p, i) => {
                const d = document.createElement('div');
                d.className = 'thumb-item';
                d.dataset.idx = i;
                d.onclick = () => { currentPhotoIndex = i; updateLightbox(); };
                const url = p.url.replace('=s800','=s200').replace('&sz=w800','&sz=w200');
                d.innerHTML = `<img src="${url}">`;
                c.appendChild(d);
            });
        }

        function navigateLightbox(dir) {
            currentPhotoIndex += dir;
            if(currentPhotoIndex < 0) currentPhotoIndex = currentAlbumPhotos.length-1;
            if(currentPhotoIndex >= currentAlbumPhotos.length) currentPhotoIndex = 0;
            updateLightbox();
        }

        async function downloadAllCurrentPhotos() {
            if(!confirm(`確定下載 ${currentAlbumPhotos.length} 張照片 (ZIP)?`)) return;
            const btn = document.getElementById('downloadAllBtn');
            const txt = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = `<div class="spinner-border spinner-border-sm"></div> 打包中...`;
            
            try {
                const zip = new JSZip();
                const folder = zip.folder(currentAlbumNameStr || "album");
                let count = 0;
                
                const promises = currentAlbumPhotos.map(async (p, i) => {
                    try {
                        const url = `https://lh3.googleusercontent.com/d/${p.id}=s2500`;
                        const res = await fetch(url);
                        if(!res.ok) throw new Error("err");
                        const blob = await res.blob();
                        let ext = 'jpg';
                        if(blob.type.includes('png')) ext='png';
                        folder.file(`${currentAlbumNameStr}_${i+1}.${ext}`, blob);
                        count++;
                    } catch(e) { console.error(e); }
                });
                
                await Promise.all(promises);
                if(count===0) throw new Error("No images loaded");
                
                const content = await zip.generateAsync({type:"blob"});
                saveAs(content, `${currentAlbumNameStr}.zip`);
            } catch(e) {
                alert("下載失敗 (瀏覽器限制或網路錯誤)");
            } finally {
                btn.disabled = false; btn.innerHTML = txt;
            }
        }

        function loadSettings() {
            SCRIPT_URL = localStorage.getItem(STORAGE_KEY_URL) || "";
            PAGE_TITLE = localStorage.getItem(STORAGE_KEY_TITLE) || "雲端相簿";
            document.title = PAGE_TITLE;
            document.getElementById('navbarTitle').innerText = PAGE_TITLE;
            document.getElementById('settingGasUrl').value = SCRIPT_URL;
            document.getElementById('settingPageTitle').value = PAGE_TITLE;
        }

        function saveSettings() {
            const url = document.getElementById('settingGasUrl').value.trim();
            const title = document.getElementById('settingPageTitle').value.trim();
            if(!url) return alert("請輸入 URL");
            localStorage.setItem(STORAGE_KEY_URL, url);
            localStorage.setItem(STORAGE_KEY_TITLE, title);
            SCRIPT_URL = url; initShareUi();
            location.reload();
        }

        function clearSettings() {
            if(confirm("確定清除設定？")) {
                localStorage.removeItem(STORAGE_KEY_URL);
                localStorage.removeItem(STORAGE_KEY_TITLE);
                sessionStorage.removeItem(SESSION_KEY_VIEWER);
                window.history.replaceState({}, document.title, window.location.pathname);
                location.reload();
            }
        }

        function initShareUi() {
            if(!SCRIPT_URL) return;
            const base = window.location.href.split('?')[0];
            const url = `${base}?ref=${btoa(SCRIPT_URL)}`;
            document.getElementById('shareLinkInput').value = url;
            document.getElementById("qrcode").innerHTML = "";
            new QRCode(document.getElementById("qrcode"), { text: url, width: 128, height: 128 });
        }

        function copyShareLink() {
            navigator.clipboard.writeText(document.getElementById('shareLinkInput').value).then(()=>alert("已複製連結"));
        }

        function showSetupState() {
            document.getElementById('albumView').classList.add('hidden');
            document.getElementById('setupState').classList.remove('hidden');
        }
        function openSettingsModal() { new bootstrap.Modal(document.getElementById('settingsModal')).show(); }
        function showLoading(show) { 
            const el = document.getElementById('loadingOverlay');
            show ? el.classList.remove('hidden') : el.classList.add('hidden');
        }
        function forceStopLoading() { showLoading(false); }
    </script>
</body>
</html>
