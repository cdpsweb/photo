<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雲端相簿 OLED</title>
    
    <!-- Typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* --- S92 OLED Style Tokens --- */
        :root {
            --bg-primary: #000000;
            --bg-secondary: #0A0A0A;
            --bg-tertiary: #111111;
            --text-primary: #FFFFFF;
            --text-secondary: #E0E0E0;
            --text-muted: #888888;
            --brand-primary: #2979FF;
            --brand-accent: #FF4081;
            --brand-success: #00E676;
            --brand-danger: #FF1744;
            --border-subtle: rgba(41, 121, 255, 0.2);
            --glow-blue: 0 0 30px rgba(41, 121, 255, 0.3);
            --font-sans: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --radius-md: 12px;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-sans);
            min-height: 100vh;
            display: flex; flex-direction: column;
            background-image: radial-gradient(rgba(41, 121, 255, 0.15) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        /* Navbar */
        .navbar-custom {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-subtle);
            padding: 1rem 0;
            position: sticky; top: 0; z-index: 1020;
        }
        .navbar-brand { font-weight: 700; color: var(--text-primary) !important; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
        .brand-dot { width: 8px; height: 8px; background-color: var(--brand-primary); border-radius: 50%; box-shadow: 0 0 10px var(--brand-primary); }

        /* Buttons */
        .btn-oled {
            background: transparent; border: 1px solid var(--border-subtle); color: var(--text-secondary);
            font-family: var(--font-mono); font-size: 0.85rem; border-radius: var(--radius-md);
            padding: 0.5rem 1rem; transition: all 0.3s; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .btn-oled:hover { border-color: var(--brand-primary); color: var(--text-primary); box-shadow: var(--glow-blue); background: rgba(41, 121, 255, 0.05); text-decoration: none; }
        .btn-oled-accent { border-color: rgba(255, 64, 129, 0.3); color: var(--brand-accent); }
        .btn-oled-accent:hover { border-color: var(--brand-accent); background: rgba(255, 64, 129, 0.05); color: #fff; }
        .btn-oled-danger { border-color: var(--brand-danger); color: var(--brand-danger); }
        .btn-oled-danger:hover { background: rgba(255, 23, 68, 0.1); box-shadow: 0 0 15px rgba(255, 23, 68, 0.3); text-decoration: none; color: #fff; }
        .btn-icon { width: 44px; height: 44px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 1.2rem; }

        /* Cards */
        .album-card {
            background-color: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-md);
            overflow: hidden; transition: all 0.3s; height: 100%; display: flex; flex-direction: column; position: relative;
        }
        .album-card:hover { transform: translateY(-4px); border-color: var(--brand-primary); box-shadow: var(--glow-blue); }
        .album-cover { height: 220px; width: 100%; object-fit: cover; border-bottom: 1px solid var(--border-subtle); }
        .album-info { padding: 1.2rem; flex-grow: 1; }
        .album-title { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; line-height: 1.4; }
        .album-meta { font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-muted); }
        
        /* Admin Controls on Album Card */
        .admin-album-controls {
            padding: 10px; border-top: 1px solid var(--border-subtle); background: rgba(0,0,0,0.2);
            display: flex; gap: 5px; justify-content: space-between;
        }
        .btn-card-action { flex: 1; font-size: 0.8rem; padding: 4px; }

        /* Photo Grid */
        .photo-item { position: relative; border-radius: var(--radius-md); overflow: hidden; aspect-ratio: 1/1; border: 1px solid transparent; cursor: pointer; transition: all 0.2s; }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
        .photo-item:hover { border-color: var(--brand-primary); }
        .photo-item:hover img { transform: scale(1.05); }
        
        /* v8.7 Multi-select Styles */
        .photo-item.selected {
            border: 2px solid var(--brand-danger);
            box-shadow: 0 0 15px rgba(255, 23, 68, 0.4);
        }
        .photo-item.selected img { opacity: 0.6; }
        
        .photo-checkbox {
            position: absolute; top: 10px; left: 10px; width: 24px; height: 24px;
            background: rgba(0,0,0,0.6); border: 2px solid rgba(255,255,255,0.7); border-radius: 4px;
            z-index: 20; display: flex; align-items: center; justify-content: center;
            pointer-events: none; /* Let parent click handle it */
            transition: 0.2s;
        }
        .photo-item.selected .photo-checkbox {
            background: var(--brand-danger); border-color: var(--brand-danger);
        }
        .photo-item.selected .photo-checkbox::after {
            content: '✓'; color: white; font-weight: bold; font-size: 14px;
        }

        /* Header Breadcrumb v8.7 Fix */
        #navHeader {
            border-bottom: 1px solid var(--border-subtle);
            padding-bottom: 2rem;
            margin-bottom: 2rem;
            background: radial-gradient(circle at top right, rgba(41, 121, 255, 0.1), transparent 40%);
        }
        .breadcrumb-item-custom {
            font-family: var(--font-mono);
            font-size: 0.95rem;
            color: var(--text-muted);
            letter-spacing: 0.05em;
            cursor: pointer !important; /* Force pointer */
            transition: color 0.2s;
            text-decoration: none;
        }
        .breadcrumb-item-custom:hover {
            color: var(--brand-primary);
            text-shadow: 0 0 8px rgba(41, 121, 255, 0.5);
            text-decoration: underline; /* Visual cue */
        }
        .breadcrumb-active { color: var(--brand-primary); text-shadow: 0 0 8px rgba(41, 121, 255, 0.5); }
        .breadcrumb-separator { color: var(--text-muted); margin: 0 0.5rem; }

        /* Inputs & Modals */
        .modal-content { background-color: var(--bg-secondary); border: 1px solid var(--border-subtle); box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .modal-header, .modal-footer { border-color: var(--border-subtle); }
        .modal-title { color: var(--text-primary); font-weight: bold; }
        .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
        .form-control, .form-select { background-color: var(--bg-tertiary); border: 1px solid var(--border-subtle); color: var(--text-primary); padding: 0.6rem; font-size: 0.9rem; }
        .form-control:focus, .form-select:focus { background-color: var(--bg-tertiary); border-color: var(--brand-primary); color: var(--text-primary); box-shadow: none; }
        .form-label { color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 0.3rem; }
        
        /* Placeholder High Contrast */
        .form-control::placeholder { color: #AAAAAA; opacity: 1; }

        /* Footer */
        .footer-custom { margin-top: auto; border-top: 1px solid var(--border-subtle); padding: 2rem 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); text-align: center; }
        .footer-text { font-family: var(--font-mono); color: var(--text-muted); font-size: 0.8rem; letter-spacing: 0.05em; }

        /* Admin Panel */
        #adminPanel { background: rgba(10, 10, 15, 0.95); border-bottom: 1px solid var(--brand-accent); padding: 1.5rem 0; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; z-index: 1010; }
        .admin-section-title { font-family: var(--font-mono); font-size: 0.8rem; color: var(--brand-accent); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; }
        .admin-section-title::after { content: ''; flex-grow: 1; height: 1px; background: rgba(255,64,129,0.2); margin-left: 10px; }

        /* Upload Status */
        .progress-container { height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden; margin-top: 1rem; }
        .progress-bar { height: 100%; background: var(--brand-accent); width: 0%; transition: width 0.3s; }
        /* v8.7: High contrast upload text */
        .upload-text-high-contrast { color: white !important; font-weight: bold; text-shadow: 0 1px 2px black; }

        /* Directory List */
        .directory-list { list-style: none; padding: 0; margin: 0; max-height: 60vh; overflow-y: auto; }
        .directory-item { padding: 1rem; border-bottom: 1px solid var(--border-subtle); cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .directory-item:hover { background: rgba(41, 121, 255, 0.1); padding-left: 1.5rem; color: var(--brand-primary); }
        .directory-item:last-child { border-bottom: none; }
        .dir-index { font-family: var(--font-mono); color: var(--text-muted); font-size: 0.8rem; margin-right: 1rem; }
        .dir-count { font-family: var(--font-mono); background: var(--bg-tertiary); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }

        /* Utils */
        .hidden { display: none !important; }
        .d-none { display: none !important; }
        
        /* Lightbox */
        #imageModal .modal-content { background: rgba(0,0,0,0.95); border: none; }
        #previewImage { max-height: calc(100vh - 160px); max-width: 90vw; }
        .lightbox-nav-btn { position: absolute; top: 50%; transform: translateY(-50%); width: 56px; height: 56px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; background: rgba(0,0,0,0.5); z-index: 1060; }
        .lightbox-prev { left: 20px; } .lightbox-next { right: 20px; }
        .thumbnail-strip-container { position: absolute; bottom: 0; width: 100%; height: 100px; background: rgba(0,0,0,0.8); display: flex; align-items: center; padding: 0 20px; overflow-x: auto; }
        .thumb-item { width: 60px; height: 60px; margin-right: 10px; opacity: 0.5; cursor: pointer; flex-shrink: 0; }
        .thumb-item.active { opacity: 1; border: 2px solid var(--brand-primary); }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar navbar-custom">
        <div class="container-fluid px-lg-5">
            <a class="navbar-brand" href="#" onclick="showAlbumList()">
                <span class="brand-dot"></span>
                <span id="navbarTitle">雲端相簿</span>
            </a>
            <div>
                <!-- Viewer Mode Label -->
                <span id="viewerModeLabel" class="d-none user-select-none me-2" style="color: var(--brand-success); font-family: var(--font-mono); font-size: 0.8rem; border: 1px solid var(--brand-success); padding: 6px 12px; border-radius: 20px;">
                    <i class="bi bi-eye-fill me-1"></i> 瀏覽模式
                </span>
                
                <!-- Admin Mode Label -->
                <span id="adminModeLabel" class="d-none user-select-none me-2" style="color: var(--brand-accent); font-family: var(--font-mono); font-size: 0.8rem; border: 1px solid var(--brand-accent); padding: 6px 12px; border-radius: 20px;">
                    <i class="bi bi-shield-check me-1"></i> 管理者模式
                </span>
                
                <!-- Admin Login Button -->
                <button id="loginBtn" class="btn-oled btn-icon btn-oled-accent btn-settings" onclick="openLoginModal()" title="管理者登入">
                    <i class="bi bi-key-fill"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Admin Panel (Embedded at Top) -->
    <div id="adminPanel" class="hidden">
        <div class="container-fluid px-lg-5">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <h5 class="text-white"><i class="bi bi-shield-lock-fill me-2" style="color: var(--brand-accent);"></i>管理者控制台</h5>
                <button class="btn-oled btn-sm btn-oled-danger" onclick="logoutAdmin()">登出</button>
            </div>

            <div class="row g-4">
                <!-- Create Album Section -->
                <div class="col-md-6 border-end border-secondary">
                    <div class="admin-section-title">相簿管理</div>
                    <div class="d-flex gap-2 mb-3">
                        <input type="text" class="form-control" id="createAlbumName" placeholder="例如:20260507_運動會">
                        <button class="btn-oled btn-oled-accent text-nowrap" onclick="createAlbum()">
                            <i class="bi bi-folder-plus me-1"></i> 建立相簿
                        </button>
                    </div>
                    <p class="small text-white-50">* 建立後請在下方列表點擊「上傳」新增照片。</p>
                </div>

                <!-- System Config Section -->
                <div class="col-md-6">
                    <div class="admin-section-title">
                        系統設定 
                    </div>
                    
                    <div id="configArea">
                        <div class="mb-2">
                            <label class="form-label small">API服務端點 (GAS URL)</label>
                            <input type="url" class="form-control form-control-sm" id="settingGasUrl" placeholder="https://script.google.com/...">
                        </div>
                        <div class="mb-2">
                            <label class="form-label small">網頁標題</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="settingPageTitle" placeholder="我的雲端相簿">
                                <button class="btn-oled btn-sm" onclick="saveSettings()">儲存</button>
                            </div>
                        </div>
                        <div class="d-flex gap-2 mt-3">
                            <button class="btn-oled btn-sm" onclick="initShareUi(); new bootstrap.Modal(document.getElementById('shareModal')).show()">
                                <i class="bi bi-share me-1"></i> 取得分享連結
                            </button>
                            <button class="btn-oled btn-sm btn-oled-danger ms-auto" onclick="clearSettings()">清除設定</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container-fluid px-lg-5 py-5">
        
        <!-- Navigation Header -->
        <div id="navHeader" class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-4">
            <div>
                <span id="homeLink" class="breadcrumb-item-custom" onclick="showAlbumList()">相簿首頁</span>
                <span id="separator" class="breadcrumb-separator hidden">//</span>
                <span id="currentAlbumName" class="breadcrumb-item-custom breadcrumb-active hidden"></span>
            </div>
            <div class="d-flex gap-2">
                <button id="directoryBtn" class="btn-oled" onclick="openDirectoryModal()"><i class="bi bi-list-ul me-2"></i> 目錄檢索</button>
                
                <!-- Batch Delete Button (Hidden) -->
                <button id="batchDeleteBtn" class="btn-oled btn-oled-danger hidden" onclick="executeBatchDelete()">
                    <i class="bi bi-trash3 me-1"></i> 刪除選取 (<span id="deleteCount">0</span>)
                </button>

                <button id="downloadAllBtn" class="btn-oled btn-oled-accent hidden" onclick="downloadAllCurrentPhotos()"><i class="bi bi-download me-2"></i> 相簿下載</button>
                
                <button id="uploadToAlbumBtn" class="btn-oled btn-oled-accent hidden" onclick="openUploadModal()">
                    <i class="bi bi-cloud-upload me-2"></i> 上傳相片
                </button>

                <button id="refreshBtn" class="btn-oled" onclick="fetchAlbums(true)"><i class="bi bi-arrow-clockwise"></i></button>
            </div>
        </div>

        <!-- Views -->
        <div id="albumView" class="row g-4"></div>
        <div id="photoView" class="row g-3 hidden"></div>
        <div id="emptyState" class="text-center py-5 hidden"><h2 class="text-muted font-monospace">查無資料 (NO_DATA)</h2></div>
        
        <!-- Initial Setup State -->
        <div id="setupState" class="text-center py-5 hidden">
            <h1 class="display-4 mb-3">系統初始化</h1>
            <p class="text-muted">尚未設定服務端點。</p>
            <button class="btn-oled btn-oled-accent px-5" onclick="openLoginModal()">管理者登入設定</button>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer-custom">
        <div class="container">
            <span class="footer-text">© 新北市崇德國小 | All Rights Reserved.</span>
        </div>
    </footer>

    <!-- Modals -->

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header border-0 d-flex justify-content-center position-relative">
                    <h5 class="modal-title w-100 text-center">你好：管理者</h5>
                    <button class="btn-close position-absolute end-0 me-3" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="password" class="form-control text-center mb-3" id="adminPassword" placeholder="請輸入密碼" autocomplete="off">
                    <button class="btn-oled w-100" onclick="verifyAdmin()">登入</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">上傳相片</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-2 text-white-50">上傳至: <span id="uploadTargetName" class="text-white fw-bold"></span></p>
                    <input type="file" class="form-control mb-3" id="uploadFiles" multiple accept="image/*">
                    
                    <div id="uploadStatus" class="hidden">
                        <div class="progress-container"><div id="uploadProgressBar" class="progress-bar"></div></div>
                        <div class="d-flex justify-content-between mt-1 font-monospace small">
                            <!-- v8.7 High Contrast Text -->
                            <span id="uploadProgressText" class="upload-text-high-contrast">準備中...</span>
                            <span id="uploadCount" class="upload-text-high-contrast"></span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="doUploadBtn" class="btn-oled btn-oled-accent w-100" onclick="startBatchUpload()">開始上傳</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rename Modal -->
    <div class="modal fade" id="renameModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">更名相簿</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="text" class="form-control mb-3" id="renameInput">
                    <input type="hidden" id="renameTargetId">
                    <button class="btn-oled w-100" onclick="confirmRename()">確認更名</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Link Modal -->
    <div class="modal fade" id="shareModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">分享連結</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body text-center">
                    <div id="qrcode" class="d-flex justify-content-center mb-3 bg-white p-2 rounded w-auto d-inline-block"></div>
                    <div class="input-group input-group-sm mb-3">
                        <input type="text" class="form-control text-center" id="shareLinkInput" readonly>
                        <button class="btn btn-outline-secondary" onclick="copyShareLink()">複製</button>
                    </div>
                    <p class="small text-muted">* 此連結包含設定參數，訪客掃描後可直接瀏覽。</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Directory Modal -->
    <div class="modal fade" id="directoryModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">相簿目錄索引</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body p-0"><ul id="directoryList" class="directory-list"></ul></div>
            </div>
        </div>
    </div>

    <!-- Lightbox -->
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-body p-0 d-flex flex-column justify-content-center align-items-center position-relative">
                    <button class="btn-close btn-close-white position-absolute top-0 end-0 m-4 z-3" data-bs-dismiss="modal"></button>
                    <a id="downloadLink" href="#" target="_blank" class="btn-oled position-absolute top-0 start-0 m-4 z-3">照片下載</a>
                    <button class="lightbox-nav-btn lightbox-prev" onclick="navigateLightbox(-1)"><i class="bi bi-chevron-left"></i></button>
                    <button class="lightbox-nav-btn lightbox-next" onclick="navigateLightbox(1)"><i class="bi bi-chevron-right"></i></button>
                    <img id="previewImage" src="" class="img-fluid">
                    <div class="thumbnail-strip-container" id="thumbnailStrip"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div id="loadingOverlay" class="hidden">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3 text-muted font-monospace">系統載入中...</p>
        <button class="btn-oled btn-oled-danger btn-sm mt-3" onclick="forceStopLoading()">終止程序</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let SCRIPT_URL = "";
        let PAGE_TITLE = "雲端相簿";
        let allData = [];
        let currentAlbumPhotos = [];
        let currentAlbumNameStr = "";
        let currentAlbumIdStr = "";
        let currentPhotoIndex = 0;
        let adminToken = ""; 
        
        // v8.7 Multi-select
        let selectedPhotoIds = new Set();

        const STORAGE_KEY_URL = "gas_album_url_v5";
        const STORAGE_KEY_TITLE = "gas_album_title_v5";
        const SESSION_KEY_VIEWER = "is_viewer_mode";
        const SESSION_KEY_ADMIN = "gas_album_admin_token";

        // Fast UI Toggle
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const ref = urlParams.get('ref');
            if(ref) {
                try {
                    localStorage.setItem(STORAGE_KEY_URL, atob(ref));
                    sessionStorage.setItem(SESSION_KEY_VIEWER, "true");
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch(e){}
            }
            if (sessionStorage.getItem(SESSION_KEY_VIEWER) === "true") {
                const style = document.createElement('style');
                style.innerHTML = '#loginBtn { display: none !important; } #viewerModeLabel { display: inline-block !important; }';
                document.head.appendChild(style);
            }
        })();

        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();

            const storedAdmin = sessionStorage.getItem(SESSION_KEY_ADMIN);
            if(storedAdmin) {
                adminToken = storedAdmin;
                document.getElementById('loginBtn').classList.add('d-none');
                document.getElementById('adminModeLabel').classList.remove('d-none');
                document.getElementById('adminPanel').classList.remove('hidden');
                initShareUi(); 
                populateAdminAlbumSelect();
            }
            
            document.addEventListener('keydown', (e) => {
                if(document.getElementById('imageModal').classList.contains('show')) {
                    if(e.key === "ArrowLeft") navigateLightbox(-1);
                    if(e.key === "ArrowRight") navigateLightbox(1);
                }
            });
            if (!SCRIPT_URL) {
                showSetupState();
            } else {
                fetchAlbums();
            }
        });

        // --- Core Functions ---

        async function safeFetchJson(url, options = {}) {
            try {
                const res = await fetch(url, options);
                const text = await res.text();
                try {
                    return JSON.parse(text);
                } catch (e) {
                    if (text.trim().startsWith("<")) {
                        throw new Error("權限錯誤：GAS 回傳了登入頁面而非資料。\n請檢查部署設定：「誰可以存取」必須設為「所有人」。");
                    }
                    throw new Error("資料格式錯誤 (非JSON)");
                }
            } catch (err) {
                throw err;
            }
        }

        async function fetchAlbums(forceRefresh = false) {
            if (!SCRIPT_URL) return;
            showLoading(true);
            try {
                let url = `${SCRIPT_URL}?action=getAlbums`;
                if (forceRefresh) url += "&refresh=true";
                const json = await safeFetchJson(url);
                if (json.status === "success") {
                    allData = json.data;
                    allData.sort((a, b) => {
                        const getDigits = s => {
                            const d = s.replace(/\D/g, '');
                            return d.length > 0 ? parseInt(d.substring(0, 8), 10) : 0;
                        };
                        const dA = getDigits(a.name||""), dB = getDigits(b.name||"");
                        if(dB !== dA) return dB - dA;
                        return (b.name||"").localeCompare((a.name||""), 'zh-TW');
                    });
                    
                    showAlbumList();
                    populateAdminAlbumSelect();
                    if(!document.getElementById('photoView').classList.contains('hidden')) {
                        const updatedAlbum = allData.find(a => a.name === currentAlbumNameStr);
                        if(updatedAlbum) showPhotos(updatedAlbum.id);
                        else showAlbumList(); 
                    }
                } else { throw new Error(json.message); }
            } catch (err) {
                console.error(err);
                if(err.message.includes("權限錯誤")) alert(err.message);
                showLoading(false);
            } finally { showLoading(false); }
        }

        function showAlbumList() {
            document.getElementById('albumView').classList.remove('hidden');
            document.getElementById('photoView').classList.add('hidden');
            document.getElementById('separator').classList.add('hidden');
            document.getElementById('currentAlbumName').classList.add('hidden');
            document.getElementById('downloadAllBtn').classList.add('hidden');
            document.getElementById('uploadToAlbumBtn').classList.add('hidden');
            document.getElementById('batchDeleteBtn').classList.add('hidden'); // Hide batch delete
            document.getElementById('directoryBtn').classList.remove('hidden');
            document.getElementById('setupState').classList.add('hidden');
            
            const view = document.getElementById('albumView');
            view.innerHTML = '';
            
            if(allData.length === 0 && !adminToken) {
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            } else {
                document.getElementById('emptyState').classList.add('hidden');
            }

            allData.forEach(album => {
                const col = document.createElement('div');
                col.className = 'col-12 col-md-4 col-lg-3';
                
                let adminBtns = "";
                if(adminToken) {
                    adminBtns = `
                        <div class="admin-album-controls">
                            <button class="btn btn-sm btn-dark btn-card-action" onclick="event.stopPropagation(); prepareRename('${album.id}', '${album.name}')">更名</button>
                            <button class="btn btn-sm btn-dark btn-card-action" onclick="event.stopPropagation(); openUploadModal('${album.name}')">上傳</button>
                            <button class="btn btn-sm btn-danger btn-card-action" onclick="event.stopPropagation(); deleteAlbum('${album.id}', '${album.name}')">刪除</button>
                        </div>`;
                }

                const coverImg = album.cover || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMjIyIi8+PC9zdmc+';

                col.innerHTML = `
                    <div class="album-card" onclick="showPhotos('${album.id}')">
                        <img src="${coverImg}" class="album-cover" loading="lazy">
                        <div class="album-info">
                            <h5 class="album-title">${album.name}</h5>
                            <div class="album-meta"><i class="bi bi-images me-1"></i> ${album.photos.length} 項目</div>
                        </div>
                        ${adminBtns}
                    </div>`;
                view.appendChild(col);
            });
        }

        function showPhotos(albumId) {
            const album = allData.find(a => a.id === albumId);
            if (!album) return;
            currentAlbumPhotos = album.photos;
            currentAlbumNameStr = album.name;
            currentAlbumIdStr = album.id;
            selectedPhotoIds.clear(); // Reset selections

            bootstrap.Modal.getInstance(document.getElementById('directoryModal'))?.hide();

            document.getElementById('albumView').classList.add('hidden');
            document.getElementById('photoView').classList.remove('hidden');
            document.getElementById('downloadAllBtn').classList.remove('hidden');
            document.getElementById('separator').classList.remove('hidden');
            document.getElementById('currentAlbumName').innerText = album.name;
            document.getElementById('currentAlbumName').classList.remove('hidden');
            
            // Toggle Admin Buttons
            if(adminToken) {
                document.getElementById('uploadToAlbumBtn').classList.remove('hidden');
                document.getElementById('uploadToAlbumBtn').onclick = () => openUploadModal(album.name);
                // Batch delete button shown only if needed, logic in selection handler
                document.getElementById('batchDeleteBtn').classList.add('hidden');
                document.getElementById('deleteCount').innerText = '0';
            }

            const view = document.getElementById('photoView');
            view.innerHTML = '';
            
            if(album.photos.length === 0) {
                view.innerHTML = '<div class="col-12 text-center text-muted py-5">此相簿是空的</div>';
            }

            album.photos.forEach((photo, index) => {
                const col = document.createElement('div');
                col.className = 'col-6 col-md-3 col-lg-2';
                
                // v8.7 Multi-select Checkbox (Admin Only)
                let selectionHtml = "";
                let clickAction = `openLightbox(${index})`;
                
                if(adminToken) {
                    selectionHtml = `<div class="photo-checkbox"></div>`;
                    clickAction = `handlePhotoSelect(event, '${photo.id}', ${index})`;
                }

                col.innerHTML = `
                    <div class="photo-item" id="p-item-${photo.id}" onclick="${clickAction}">
                        ${selectionHtml}
                        <img src="${photo.url.replace('=s800', '=s400')}" loading="lazy">
                    </div>`;
                view.appendChild(col);
            });
        }

        // v8.7 Photo Selection Handler
        function handlePhotoSelect(event, id, index) {
            // Prevent opening lightbox immediately if in selection mode
            event.stopPropagation();
            
            const el = document.getElementById(`p-item-${id}`);
            
            if (selectedPhotoIds.has(id)) {
                selectedPhotoIds.delete(id);
                el.classList.remove('selected');
            } else {
                selectedPhotoIds.add(id);
                el.classList.add('selected');
            }
            
            // Update UI
            const count = selectedPhotoIds.size;
            const delBtn = document.getElementById('batchDeleteBtn');
            const dlBtn = document.getElementById('downloadAllBtn');
            
            if (count > 0) {
                delBtn.classList.remove('hidden');
                document.getElementById('deleteCount').innerText = count;
                dlBtn.classList.add('hidden'); // Hide download to avoid clutter
            } else {
                delBtn.classList.add('hidden');
                dlBtn.classList.remove('hidden');
                // If clicked without selection, maybe open lightbox? 
                // For better UX in admin mode, click = toggle select. 
                // Double click or view icon = lightbox.
                // Current logic: click = select. To view, admin might need another way or just deselect all.
                // Let's keep it simple: Admin click = toggle select.
            }
        }

        // v8.7 Execute Batch Delete
        async function executeBatchDelete() {
            const count = selectedPhotoIds.size;
            if (count === 0) return;
            
            if (!confirm(`確定要刪除選取的 ${count} 張照片嗎？\n(此動作無法復原)`)) return;
            
            showLoading(true);
            const ids = Array.from(selectedPhotoIds);
            let success = 0;
            
            // Sequential deletion to be safe with GAS quota
            for (const id of ids) {
                try {
                    const payload = {
                        action: 'deletePhoto',
                        id: id,
                        password: adminToken
                    };
                    const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                    const json = await res.json();
                    if(json.status === "success") success++;
                } catch(e) { console.error(e); }
            }
            
            showLoading(false);
            alert(`刪除完成！成功 ${success} / ${count}`);
            selectedPhotoIds.clear();
            fetchAlbums(true); // Reload
        }

        // --- Admin Logic ---

        function showAdminPanel(showSettings = false) {
            const panel = document.getElementById('adminPanel');
            panel.classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function openLoginModal() {
            document.getElementById('adminPassword').value = "";
            if(!SCRIPT_URL) { 
                showAdminPanel(true);
                return;
            }
            new bootstrap.Modal(document.getElementById('loginModal')).show();
        }

        async function verifyAdmin() {
            const pwd = document.getElementById('adminPassword').value;
            if(!pwd) return alert("請輸入密碼");
            showLoading(true);
            try {
                const url = `${SCRIPT_URL}?action=verifyAdmin&password=${encodeURIComponent(pwd)}`;
                const json = await safeFetchJson(url);
                if(json.status === "success") {
                    adminToken = pwd;
                    sessionStorage.setItem(SESSION_KEY_ADMIN, pwd);
                    
                    document.getElementById('adminPassword').value = "";
                    bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
                    
                    showAdminPanel(); 
                    
                    document.getElementById('loginBtn').classList.add('d-none');
                    document.getElementById('adminModeLabel').classList.remove('d-none');
                    
                    alert("登入成功！");
                    fetchAlbums(true); 
                } else { alert("密碼錯誤"); }
            } catch(e) { alert("驗證失敗: " + e.message); }
            finally { showLoading(false); }
        }

        function logoutAdmin() {
            adminToken = "";
            sessionStorage.removeItem(SESSION_KEY_ADMIN);
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('adminPassword').value = ""; 
            
            document.getElementById('loginBtn').classList.remove('d-none');
            document.getElementById('adminModeLabel').classList.add('d-none');

            showAlbumList();
            alert("已登出");
        }

        // API Actions
        async function createAlbum() {
            const name = document.getElementById('createAlbumName').value.trim();
            if(!name) return alert("請輸入相簿名稱");
            callApi({ action: 'createAlbum', albumName: name, password: adminToken }, "相簿建立成功！");
        }

        async function deleteAlbum(id, name) {
            if(!confirm(`確定要刪除相簿「${name}」及其所有照片嗎？\n(此動作無法復原)`)) return;
            callApi({ action: 'deleteAlbum', id: id, password: adminToken });
        }

        function prepareRename(id, oldName) {
            document.getElementById('renameTargetId').value = id;
            document.getElementById('renameInput').value = oldName;
            new bootstrap.Modal(document.getElementById('renameModal')).show();
        }

        async function confirmRename() {
            const id = document.getElementById('renameTargetId').value;
            const newName = document.getElementById('renameInput').value.trim();
            if(!newName) return alert("名稱不能為空");
            bootstrap.Modal.getInstance(document.getElementById('renameModal')).hide();
            callApi({ action: 'renameAlbum', id: id, newName: newName, password: adminToken });
        }

        // async function deletePhoto(id) { ... } -> Replaced by batch delete

        async function callApi(payload, successMsg) {
            showLoading(true);
            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                const json = await res.json();
                if(json.status === "success") {
                    if(successMsg) alert(successMsg);
                    document.getElementById('createAlbumName').value = ""; 
                    fetchAlbums(true);
                } else {
                    alert("操作失敗: " + json.message);
                }
            } catch(e) { console.error(e); alert("連線錯誤"); }
            finally { showLoading(false); }
        }

        // Upload Logic
        function openUploadModal(preselectName = null) {
            const modal = new bootstrap.Modal(document.getElementById('uploadModal'));
            document.getElementById('uploadTargetName').innerText = preselectName || currentAlbumNameStr || "未選擇";
            document.getElementById('uploadModal').dataset.targetAlbum = preselectName || currentAlbumNameStr;
            modal.show();
        }

        async function startBatchUpload() {
            const albumName = document.getElementById('uploadModal').dataset.targetAlbum;
            if(!albumName) return alert("無法確認目標相簿");
            const files = document.getElementById('uploadFiles').files;
            if(files.length === 0) return alert("請選擇檔案");

            document.getElementById('uploadStatus').classList.remove('hidden');
            const pBar = document.getElementById('uploadProgressBar');
            const pText = document.getElementById('uploadProgressText');
            const pCount = document.getElementById('uploadCount');
            const doBtn = document.getElementById('doUploadBtn');
            
            doBtn.disabled = true;
            pBar.style.width = "0%";
            pCount.innerText = "0%";
            
            let successCount = 0;
            const total = files.length;

            for(let i=0; i<total; i++) {
                const file = files[i];
                pText.innerText = `上傳中 (${i+1}/${total}): ${file.name}`;
                try {
                    const base64 = await toBase64(file);
                    const payload = { action: 'upload', password: adminToken, albumName: albumName, fileName: file.name, image: base64 };
                    const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                    const json = await res.json();
                    if(json.status === "success") successCount++;
                } catch(e) { console.error(e); }
                
                const pct = Math.round(((i+1)/total)*100);
                pBar.style.width = `${pct}%`;
                pCount.innerText = `${pct}%`;
            }
            
            // Force 100% UI update
            pBar.style.width = "100%";
            pCount.innerText = "100%";
            pText.innerText = "處理完成";
            await new Promise(r => setTimeout(r, 500)); 

            alert(`上傳完成！成功 ${successCount} / ${total}`);
            document.getElementById('uploadFiles').value = "";
            document.getElementById('uploadStatus').classList.add('hidden');
            doBtn.disabled = false;
            bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
            fetchAlbums(true);
        }

        // --- Standard Helpers ---
        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function openDirectoryModal() {
            const list = document.getElementById('directoryList');
            list.innerHTML = '';
            allData.forEach((album, i) => {
                const li = document.createElement('li');
                li.className = 'directory-item';
                const num = (i+1).toString().padStart(2,'0');
                li.innerHTML = `<div><span class="dir-index">[${num}]</span> ${album.name}</div><span class="dir-count">${album.photos.length}</span>`;
                li.onclick = () => { showPhotos(album.id); bootstrap.Modal.getInstance(document.getElementById('directoryModal')).hide(); };
                list.appendChild(li);
            });
            new bootstrap.Modal(document.getElementById('directoryModal')).show();
        }

        function openLightbox(index) {
            currentPhotoIndex = index;
            updateLightbox();
            renderThumbs();
            new bootstrap.Modal(document.getElementById('imageModal')).show();
        }

        function updateLightbox() {
            const p = currentAlbumPhotos[currentPhotoIndex];
            const img = document.getElementById('previewImage');
            img.style.opacity = '0.5';
            const url = p.url.replace('=s800','=s1600').replace('&sz=w800','&sz=w1600');
            const newI = new Image();
            newI.onload = () => { img.src = url; img.style.opacity = '1'; };
            newI.src = url;
            document.getElementById('downloadLink').href = p.downloadUrl;
            
            document.querySelectorAll('.thumb-item').forEach(el => el.classList.remove('active'));
            const active = document.querySelector(`.thumb-item[data-idx="${currentPhotoIndex}"]`);
            if(active) {
                active.classList.add('active');
                active.scrollIntoView({ behavior: 'smooth', inline: 'center' });
            }
        }

        function renderThumbs() {
            const c = document.getElementById('thumbnailStrip');
            c.innerHTML = '';
            currentAlbumPhotos.forEach((p, i) => {
                const d = document.createElement('div');
                d.className = 'thumb-item';
                d.dataset.idx = i;
                d.onclick = () => { currentPhotoIndex = i; updateLightbox(); };
                const url = p.url.replace('=s800','=s200').replace('&sz=w800','&sz=w200');
                d.innerHTML = `<img src="${url}">`;
                c.appendChild(d);
            });
        }

        function navigateLightbox(dir) {
            currentPhotoIndex += dir;
            if(currentPhotoIndex < 0) currentPhotoIndex = currentAlbumPhotos.length-1;
            if(currentPhotoIndex >= currentAlbumPhotos.length) currentPhotoIndex = 0;
            updateLightbox();
        }

        async function downloadAllCurrentPhotos() {
            if(!confirm(`下載 ${currentAlbumPhotos.length} 張照片 (ZIP)?`)) return;
            const btn = document.getElementById('downloadAllBtn');
            const txt = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = `<div class="spinner-border spinner-border-sm"></div> 打包中...`;
            try {
                const zip = new JSZip();
                const folder = zip.folder(currentAlbumNameStr || "album");
                let count = 0;
                const promises = currentAlbumPhotos.map(async (p, i) => {
                    try {
                        const url = `https://lh3.googleusercontent.com/d/${p.id}=s2500`;
                        const res = await fetch(url);
                        if(!res.ok) throw new Error("err");
                        const blob = await res.blob();
                        let ext = 'jpg';
                        if(blob.type.includes('png')) ext='png';
                        folder.file(`${currentAlbumNameStr}_${i+1}.${ext}`, blob);
                        count++;
                    } catch(e) { }
                });
                await Promise.all(promises);
                if(count===0) throw new Error("No images loaded");
                const content = await zip.generateAsync({type:"blob"});
                saveAs(content, `${currentAlbumNameStr}.zip`);
            } catch(e) { alert("下載失敗"); } 
            finally { btn.disabled = false; btn.innerHTML = txt; }
        }

        function loadSettings() {
            SCRIPT_URL = localStorage.getItem(STORAGE_KEY_URL) || "";
            PAGE_TITLE = localStorage.getItem(STORAGE_KEY_TITLE) || "雲端相簿";
            document.title = PAGE_TITLE;
            document.getElementById('navbarTitle').innerText = PAGE_TITLE;
            document.getElementById('settingGasUrl').value = SCRIPT_URL;
            document.getElementById('settingPageTitle').value = PAGE_TITLE;
        }

        function saveSettings() {
            const url = document.getElementById('settingGasUrl').value.trim();
            const title = document.getElementById('settingPageTitle').value.trim();
            if(!url) return alert("請輸入 URL");
            localStorage.setItem(STORAGE_KEY_URL, url);
            localStorage.setItem(STORAGE_KEY_TITLE, title);
            SCRIPT_URL = url; initShareUi();
            location.reload();
        }

        function clearSettings() {
            if(confirm("確定清除設定？")) {
                localStorage.removeItem(STORAGE_KEY_URL);
                localStorage.removeItem(STORAGE_KEY_TITLE);
                sessionStorage.removeItem(SESSION_KEY_VIEWER);
                window.history.replaceState({}, document.title, window.location.pathname);
                location.reload();
            }
        }

        function initShareUi() {
            if(!SCRIPT_URL) return;
            const base = window.location.href.split('?')[0];
            const url = `${base}?ref=${btoa(SCRIPT_URL)}`;
            document.getElementById('shareLinkInput').value = url;
            document.getElementById("qrcode").innerHTML = "";
            new QRCode(document.getElementById("qrcode"), { text: url, width: 128, height: 128 });
        }

        function copyShareLink() {
            navigator.clipboard.writeText(document.getElementById('shareLinkInput').value).then(()=>alert("已複製連結"));
        }

        function showSetupState() {
            document.getElementById('albumView').classList.add('hidden');
            document.getElementById('setupState').classList.remove('hidden');
        }
        function openSettingsModal() { new bootstrap.Modal(document.getElementById('settingsModal')).show(); }
        function showLoading(show) { 
            const el = document.getElementById('loadingOverlay');
            show ? el.classList.remove('hidden') : el.classList.add('hidden');
        }
        function forceStopLoading() { showLoading(false); }
    </script>
</body>
</html>
