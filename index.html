<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雲端相簿 OLED</title>
    
    <!-- Typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Libraries (Place JS at the end of head or before body close) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Bootstrap 5 JS Bundle (Includes Popper) - CRITICAL FIX -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        /* --- S92 OLED Style Tokens --- */
        :root {
            --bg-primary: #000000;
            --bg-secondary: #0A0A0A;
            --bg-tertiary: #111111;
            --text-primary: #FFFFFF;
            --text-secondary: #E0E0E0;
            --text-muted: #888888;
            --brand-primary: #2979FF;
            --brand-accent: #FF4081;
            --brand-success: #00E676;
            --brand-danger: #FF1744;
            --border-subtle: rgba(41, 121, 255, 0.2);
            --glow-blue: 0 0 30px rgba(41, 121, 255, 0.3);
            --glow-pink: 0 0 30px rgba(255, 64, 129, 0.3);
            --glow-text: 0 0 10px rgba(255, 255, 255, 0.5);
            
            --font-sans: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --radius-md: 12px;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-sans);
            min-height: 100vh;
            display: flex; flex-direction: column;
            background-image: radial-gradient(rgba(41, 121, 255, 0.15) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        /* Navbar */
        .navbar-custom {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-subtle);
            padding: 1rem 0;
            position: sticky; top: 0; z-index: 1020;
        }
        .navbar-brand { font-weight: 700; color: var(--text-primary) !important; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
        .brand-dot { width: 8px; height: 8px; background-color: var(--brand-primary); border-radius: 50%; box-shadow: 0 0 10px var(--brand-primary); }

        /* Buttons */
        .btn-oled {
            background: transparent; border: 1px solid var(--border-subtle); color: var(--text-secondary);
            font-family: var(--font-mono); font-size: 0.85rem; border-radius: var(--radius-md);
            padding: 0.5rem 1rem; transition: all 0.3s; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .btn-oled:hover { border-color: var(--brand-primary); color: var(--text-primary); box-shadow: var(--glow-blue); background: rgba(41, 121, 255, 0.05); text-decoration: none; }
        
        .btn-oled-accent { border-color: rgba(255, 64, 129, 0.3); color: var(--brand-accent); }
        .btn-oled-accent:hover { 
            border-color: var(--brand-accent); background: rgba(255, 64, 129, 0.05); 
            color: #fff; box-shadow: var(--glow-pink); text-decoration: none;
        }
        
        .btn-oled-danger { border-color: var(--brand-danger); color: var(--brand-danger); }
        .btn-oled-danger:hover { background: rgba(255, 23, 68, 0.1); box-shadow: 0 0 15px rgba(255, 23, 68, 0.3); text-decoration: none; color: #fff; }
        .btn-icon { width: 44px; height: 44px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 1.2rem; }

        /* Cards */
        .album-card {
            background-color: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: var(--radius-md);
            overflow: hidden; transition: all 0.3s; height: 100%; display: flex; flex-direction: column; position: relative;
        }
        .album-card:hover { transform: translateY(-4px); border-color: var(--brand-primary); box-shadow: var(--glow-blue); }
        .album-cover { height: 220px; width: 100%; object-fit: cover; border-bottom: 1px solid var(--border-subtle); cursor: pointer; }
        .album-info { padding: 1.2rem; flex-grow: 1; cursor: pointer; }
        .album-title { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; line-height: 1.4; }
        .album-meta { font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-muted); }

        /* Photo Grid */
        .photo-item { position: relative; border-radius: var(--radius-md); overflow: hidden; aspect-ratio: 1/1; border: 1px solid transparent; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; pointer-events: none; }
        .photo-item:hover { border-color: var(--brand-primary); }
        .photo-item:hover img { transform: scale(1.05); }

        /* Breadcrumb */
        #navHeader { border-bottom: 1px solid var(--border-subtle); padding-bottom: 2rem; margin-bottom: 2rem; }
        .breadcrumb-item-custom { font-family: var(--font-mono); font-size: 0.95rem; color: var(--text-muted); letter-spacing: 0.05em; cursor: pointer; text-decoration: none; }
        .breadcrumb-item-custom:hover { color: var(--brand-primary); text-shadow: 0 0 8px rgba(41, 121, 255, 0.5); }
        .breadcrumb-active { color: var(--brand-primary); text-shadow: 0 0 8px rgba(41, 121, 255, 0.5); }
        .breadcrumb-separator { color: var(--text-muted); margin: 0 0.5rem; }

        /* Modals */
        .modal-content { background-color: var(--bg-secondary); border: 1px solid var(--border-subtle); }
        .modal-header, .modal-footer { border-color: var(--border-subtle); }
        .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
        .form-control { background-color: var(--bg-tertiary); border: 1px solid var(--border-subtle); color: var(--text-primary); }
        .form-control:focus { background-color: var(--bg-tertiary); border-color: var(--brand-primary); color: var(--text-primary); box-shadow: none; }

        .hidden { display: none !important; }

        /* SweetAlert2 OLED Theme */
        .swal2-popup { background: var(--bg-secondary) !important; color: white !important; border: 1px solid var(--border-subtle) !important; }
        .swal2-title, .swal2-html-container { color: white !important; }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar navbar-custom">
        <div class="container-fluid px-lg-5">
            <a class="navbar-brand" href="#" onclick="showAlbumList()">
                <span class="brand-dot"></span>
                <span id="navbarTitle">雲端相簿</span>
            </a>
            <div>
                <span id="adminBadge" class="d-none me-2" style="color: var(--brand-accent); font-family: var(--font-mono); font-size: 0.8rem; border: 1px solid var(--brand-accent); padding: 6px 12px; border-radius: 20px;">
                    <i class="bi bi-shield-check me-1"></i> 管理者模式
                </span>
                
                <div id="adminControls" class="d-none d-inline-flex align-items-center gap-2">
                    <button class="btn-oled btn-sm" onclick="openSettingsModal()">
                        <i class="bi bi-gear-fill me-1"></i> 系統設定
                    </button>
                    <button class="btn-oled btn-sm btn-oled-danger" onclick="logoutAdmin()">
                        <i class="bi bi-box-arrow-right"></i>
                    </button>
                </div>
                
                <button id="loginBtn" class="btn-oled btn-icon btn-oled-accent" onclick="openLoginModal()" title="管理者登入">
                    <i class="bi bi-key-fill"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid px-lg-5 py-5">
        <div id="navHeader" class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-4">
            <div>
                <span class="breadcrumb-item-custom" onclick="showAlbumList()">相簿首頁</span>
                <span id="separator" class="breadcrumb-separator hidden">//</span>
                <span id="currentAlbumName" class="breadcrumb-item-custom breadcrumb-active hidden"></span>
            </div>
            <div class="d-flex gap-2">
                <button class="btn-oled" onclick="refreshData()"><i class="bi bi-arrow-clockwise"></i></button>
            </div>
        </div>

        <!-- Views -->
        <div id="albumView" class="row g-4">
            <div class="text-center py-5">
                <h2 class="text-muted font-monospace">正在載入相簿資料...</h2>
            </div>
        </div>
        
        <div id="photoView" class="row g-3 hidden"></div>
        
        <!-- Setup State -->
        <div id="setupState" class="text-center py-5 hidden">
            <h1 class="display-4 mb-3" style="color: var(--brand-primary); text-shadow: var(--glow-blue);">系統初始化</h1>
            <p class="text-muted mb-4">偵測到尚未設定後端服務端點 (GAS URL)。<br>請點擊下方按鈕進行設定，以串接您的 Google Drive 相簿。</p>
            <button class="btn-oled btn-oled-accent px-5 py-3" onclick="openSettingsModal()">
                <i class="bi bi-plug-fill me-2"></i>開始設定 API URL
            </button>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header border-0 justify-content-center">
                    <h5 class="modal-title">管理者登入</h5>
                </div>
                <div class="modal-body">
                    <input type="password" class="form-control text-center mb-3" id="adminPassword" placeholder="請輸入密碼">
                    <button class="btn-oled w-100" onclick="verifyAdmin()">登入</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-gear-wide-connected me-2"></i>系統設定</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label small">API 服務端點 (GAS 部署網址)</label>
                        <input type="url" class="form-control" id="settingGasUrl" placeholder="https://script.google.com/macros/s/.../exec">
                        <div class="form-text text-muted mt-2">請貼上您在 GAS 部署為網頁應用程式後獲得的網址。</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small">網頁標題</label>
                        <input type="text" class="form-control" id="settingPageTitle" placeholder="雲端相簿">
                    </div>
                    <button class="btn-oled w-100 btn-oled-accent mt-3" onclick="saveSettings()">
                        <i class="bi bi-save2 me-2"></i>儲存並更新
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Global State ---
        let SCRIPT_URL = localStorage.getItem('gas_api_url') || "";
        let PAGE_TITLE = localStorage.getItem('page_title') || "雲端相簿";
        let isAdmin = false;
        let albums = [];
        let currentAlbumId = null;

        // --- Init ---
        window.addEventListener('DOMContentLoaded', () => {
            // 套用基礎設定
            document.getElementById('navbarTitle').innerText = PAGE_TITLE;
            document.getElementById('settingGasUrl').value = SCRIPT_URL;
            document.getElementById('settingPageTitle').value = PAGE_TITLE;

            // 判斷是否需要進入初始化狀態
            if (!SCRIPT_URL || SCRIPT_URL.trim() === "") {
                document.getElementById('albumView').classList.add('hidden');
                document.getElementById('setupState').classList.remove('hidden');
                
                // 確保 Bootstrap JS 載入後再開啟彈窗
                setTimeout(() => {
                    if (typeof bootstrap !== 'undefined') {
                        openSettingsModal();
                    }
                }, 1000);
            } else {
                fetchAlbums();
            }
        });

        // --- API Functions ---
        async function fetchAlbums(refresh = false) {
            if (!SCRIPT_URL) return;
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getAlbums${refresh ? '&refresh=true' : ''}`);
                const result = await response.json();
                if (result.status === "success") {
                    albums = result.data;
                    renderAlbums();
                }
            } catch (e) {
                console.error("Fetch failed", e);
                Swal.fire('連線失敗', '無法從 API 獲取資料，請檢查 GAS URL 是否正確。', 'error');
            }
        }

        function renderAlbums() {
            const container = document.getElementById('albumView');
            container.innerHTML = '';
            document.getElementById('setupState').classList.add('hidden');
            container.classList.remove('hidden');
            
            if (albums.length === 0) {
                container.innerHTML = '<div class="text-center py-5"><h2 class="text-muted font-monospace">尚無相簿資料</h2></div>';
                return;
            }

            albums.forEach(album => {
                const col = document.createElement('div');
                col.className = 'col-12 col-md-6 col-lg-4 col-xl-3';
                col.innerHTML = `
                    <div class="album-card">
                        <img src="${album.cover || 'https://via.placeholder.com/400x220/111/fff?text=No+Image'}" class="album-cover" onclick="openAlbum('${album.id}')">
                        <div class="album-info" onclick="openAlbum('${album.id}')">
                            <div class="album-title">${album.name}</div>
                            <div class="album-meta">${album.photos ? album.photos.length : 0} 個項目</div>
                        </div>
                    </div>
                `;
                container.appendChild(col);
            });
        }

        function openAlbum(id) {
            currentAlbumId = id;
            const album = albums.find(a => a.id === id);
            if (!album) return;

            document.getElementById('albumView').classList.add('hidden');
            document.getElementById('photoView').classList.remove('hidden');
            document.getElementById('separator').classList.remove('hidden');
            document.getElementById('currentAlbumName').classList.remove('hidden');
            document.getElementById('currentAlbumName').innerText = album.name;
            
            const container = document.getElementById('photoView');
            container.innerHTML = '';
            
            if (!album.photos || album.photos.length === 0) {
                container.innerHTML = '<div class="text-center py-5 w-100"><h2 class="text-muted font-monospace">此相簿內沒有相片</h2></div>';
                return;
            }

            album.photos.forEach(photo => {
                const col = document.createElement('div');
                col.className = 'col-6 col-md-4 col-lg-2';
                col.innerHTML = `
                    <div class="photo-item">
                        <img src="${photo.url}" loading="lazy">
                    </div>
                `;
                container.appendChild(col);
            });
        }

        function showAlbumList() {
            currentAlbumId = null;
            document.getElementById('albumView').classList.remove('hidden');
            document.getElementById('photoView').classList.add('hidden');
            document.getElementById('separator').classList.add('hidden');
            document.getElementById('currentAlbumName').classList.add('hidden');
        }

        // --- Core Action ---
        function saveSettings() {
            const urlInput = document.getElementById('settingGasUrl').value.trim();
            const titleInput = document.getElementById('settingPageTitle').value.trim();
            
            if (urlInput === "") {
                Swal.fire('提醒', '請輸入有效的 API URL', 'warning');
                return;
            }

            localStorage.setItem('gas_api_url', urlInput);
            localStorage.setItem('page_title', titleInput || "雲端相簿");

            Swal.fire({
                icon: 'success',
                title: '設定已儲存',
                text: '正在重新載入系統...',
                timer: 1500,
                showConfirmButton: false
            }).then(() => {
                window.location.reload();
            });
        }

        // --- Admin Functions ---
        async function verifyAdmin() {
            const pwd = document.getElementById('adminPassword').value;
            if (!pwd) return;
            
            try {
                const response = await fetch(`${SCRIPT_URL}?action=verifyAdmin&password=${encodeURIComponent(pwd)}`);
                const result = await response.json();
                
                if (result.status === "success") {
                    isAdmin = true;
                    document.getElementById('adminBadge').classList.remove('d-none');
                    document.getElementById('adminControls').classList.remove('d-none');
                    document.getElementById('loginBtn').classList.add('d-none');
                    const modalEl = document.getElementById('loginModal');
                    const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                    modal.hide();
                    renderAlbums();
                    Swal.fire({ icon: 'success', title: '管理者已登入', timer: 1500, showConfirmButton: false });
                } else {
                    Swal.fire('錯誤', '密碼不正確', 'error');
                }
            } catch (e) {
                Swal.fire('錯誤', '無法連線至 API 驗證密碼', 'error');
            }
        }

        function logoutAdmin() {
            isAdmin = false;
            document.getElementById('adminBadge').classList.add('d-none');
            document.getElementById('adminControls').classList.add('d-none');
            document.getElementById('loginBtn').classList.remove('d-none');
            renderAlbums();
        }

        function refreshData() {
            if (!SCRIPT_URL) return;
            fetchAlbums(true);
        }

        // --- Modal Helpers ---
        function openLoginModal() { 
            const modalEl = document.getElementById('loginModal');
            const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modal.show();
        }
        function openSettingsModal() { 
            const modalEl = document.getElementById('settingsModal');
            if (typeof bootstrap !== 'undefined') {
                const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                modal.show();
            } else {
                console.error("Bootstrap is not loaded yet.");
            }
        }
    </script>
</body>
</html>
